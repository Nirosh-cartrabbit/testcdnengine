(function(U,X){typeof exports=="object"&&typeof module<"u"?module.exports=X():typeof define=="function"&&define.amd?define(X):(U=typeof globalThis<"u"?globalThis:U||self,U.retainfulpoupengine=X())})(this,function(){"use strict";var Yr=Object.defineProperty;var Wr=(U,X,oe)=>X in U?Yr(U,X,{enumerable:!0,configurable:!0,writable:!0,value:oe}):U[X]=oe;var N=(U,X,oe)=>(Wr(U,typeof X!="symbol"?X+"":X,oe),oe);const pe=class{constructor(){N(this,"records",[])}static getInstance(){return pe.instance||(pe.instance=new pe),pe.instance}getRecords(){return this.records}addRecord(e){this.records.push(e)}getRecord(e){return this.records.find(t=>t.id===e)}deleteRecord(e){this.records=this.records.filter(t=>t.id!==e)}updateRecord(e,t){this.records=this.records.map(n=>n.id===e?t:n)}};let U=pe;N(U,"instance");class X{constructor(){N(this,"observers");this.observers=[]}subscribe(e){this.observers.push(e)}unsubscribe(e){this.observers=this.observers.filter(t=>t!==e)}notify(e){this.observers.forEach(t=>t.update(e))}}function oe(r,e,t){const n=new Date;n.setTime(n.getTime()+t*24*60*60*1e3);const i="expires="+n.toUTCString();document.cookie=r+"="+e+";"+i+";path=/"}function le(r){var n;const t=("; "+document.cookie).split("; "+r+"=");return t.length==2?(n=t.pop())==null?void 0:n.split(";").shift():""}var ot=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function st(r){var e=r.default;if(typeof e=="function"){var t=function n(){if(this instanceof n){var i=[null];i.push.apply(i,arguments);var l=Function.bind.apply(e,i);return new l}return e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(r).forEach(function(n){var i=Object.getOwnPropertyDescriptor(r,n);Object.defineProperty(t,n,i.get?i:{enumerable:!0,get:function(){return r[n]}})}),t}var Ge={exports:{}},re={},se={},ye={},Ye={exports:{}};(function(r,e){(function(t,n){r.exports=n()})(ot,function(){function t(s){for(var h=s.length,d=5381,g=52711,A;h--;)A=s.charCodeAt(h),d=d*33^A,g=g*33^A;return(d>>>0)*4096+(g>>>0)}var n=function(h,d){return h.reduce(function(g,A){var O="[object "+A+"]";return d?g[O]=A:g[A]=O,g},{})},i=function(h){return h.reduce(function(d,g){return d[g]=!0,d},{})},l=["Array","Arguments","Object","RegExp","Symbol","Map","Set","Date","Error","Event","Generator","Promise","WeakMap","WeakSet","DocumentFragment","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","ArrayBuffer","DataView","DocumentFragment","Window","String","Number","Boolean","Function","Undefined","GeneratorFunction","BigInt","Null"],f=n(l,!1),y=n(l,!0),w=i([f.Generator,f.Promise,f.WeakMap,f.WeakSet]),R=i([f.Map,f.Set]),b=i([f.Date,f.RegExp]),F=i(["bigint","boolean","function","number","string","undefined"]),E=i([f.Arguments,f.Array]),_=i([f.RegExp,f.Symbol]),T=i([f.Float32Array,f.Float64Array,f.Int8Array,f.Int16Array,f.Int32Array,f.Uint8Array,f.Uint8ClampedArray,f.Uint16Array,f.Uint32Array]),j=typeof Buffer<"u"&&typeof Buffer.from=="function",M=typeof Uint16Array=="function";function q(s){return String.fromCharCode.apply(null,new Uint16Array(s))}function G(s){return Buffer.from(s).toString("utf8")}function te(s){return""}var V=function(){return j?G:M?q:te}(),S=/\[object ([HTML|SVG](.*)Element)\]/,B=Object.prototype.toString,k=Object.keys;function Y(s){return{bubbles:s.bubbles,cancelBubble:s.cancelBubble,cancelable:s.cancelable,composed:s.composed,currentTarget:s.currentTarget,defaultPrevented:s.defaultPrevented,eventPhase:s.eventPhase,isTrusted:s.isTrusted,returnValue:s.returnValue,target:s.target,type:s.type}}function C(s,h){return s>h}function D(s,h){return s[0]>h[0]}function z(s,h){for(var d,g,A=0;A<s.length;++A){for(g=s[A],d=A-1;~d&&h(s[d],g);--d)s[d+1]=s[d];s[d+1]=g}return s}function Q(s,h,d){var g=[];s.forEach(function(I,L){g.push([o(L,h,d),o(I,h,d)])}),z(g,D);for(var A=0,O;A<g.length;++A)O=g[A],g[A]="["+O[0]+","+O[1]+"]";return"Map|["+g.join(",")+"]"}function J(s,h,d){var g=[];return s.forEach(function(A){g.push(o(A,h,d))}),z(g,C),"Set|["+g.join(",")+"]"}function H(s){for(var h=z(k(s),C),d={},g,A=0;A<h.length;++A)g=h[A],d[g]=s[g];return d}function P(s){for(var h=s.children,d=[],g=0;g<h.length;++g)d.push(h[g].outerHTML);return d.join(",")}function W(s,h){for(var d=0;d<s.length;++d)if(s[d]===h)return d+1;return 0}function x(s,h,d,g){if(!g){var A=typeof s;if(F[A])return A+"|"+s;if(s===null)return s+"|"+s}var O=g||B.call(s);return E[O]?s:O===f.Object?H(s):_[O]?y[O]+"|"+s.toString():R[O]?s instanceof Map?Q(s,h,d):J(s,h,d):O===f.Date?y[O]+"|"+s.getTime():O===f.Error?y[O]+"|"+s.stack:O===f.Event?Y(s):w[O]?y[O]+"|NOT_ENUMERABLE":S.test(O)?O.slice(8,-1)+"|"+s.outerHTML:O===f.DocumentFragment?y[O]+"|"+P(s):T[O]?y[O]+"|"+s.join(","):O===f.ArrayBuffer?y[O]+"|"+V(s):O===f.DataView?y[O]+"|"+V(s.buffer):s}function a(s,h){return s===void 0&&(s=[]),h===void 0&&(h=[]),function(d,g){if(typeof g=="object")if(s.length){var A=W(s,this);A===0?s.push(this):(s.splice(A),h.splice(A)),h.push(d);var O=W(s,g);if(O!==0)return"[~"+(h.slice(0,O).join(".")||".")+"]";s.push(g)}else s[0]=g,h[0]=d;return d&&this[d]instanceof Date?x(this[d],s,h,f.Date):x(g,s,h)}}function o(s,h,d){if(!s||typeof s!="object")return x(s,h,d);var g=B.call(s);return b[g]?x(s,h,d,g):JSON.stringify(s,a(h,d))}function u(s){return t(o(s))}function c(s,h){return u(s)===u(h)}function v(s){for(var h=0;h<(arguments.length<=1?0:arguments.length-1);++h)if(!c(s,h+1<1||arguments.length<=h+1?void 0:arguments[h+1]))return!1;return!0}function p(s){for(var h=0;h<(arguments.length<=1?0:arguments.length-1);++h)if(c(s,h+1<1||arguments.length<=h+1?void 0:arguments[h+1]))return!0;return!1}function m(s,h){return u(s)!==u(h)}return c.all=v,c.any=p,c.not=m,u.is=c,u})})(Ye),Object.defineProperty(ye,"__esModule",{value:!0});var ut=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),lt=Ye.exports,ft=ct(lt);function ct(r){return r&&r.__esModule?r:{default:r}}function ht(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Re=function(){function r(e,t,n){ht(this,r),this.id=e;var i={cache:!0};if(typeof n>"u"&&(n=i),typeof t!="function"?(this.value=t,this.type=this.constructor.CONSTANT):(this.calculationMethod=t,this.type=this.constructor.DYNAMIC),!this.id)throw new Error("factId required");return this.priority=parseInt(n.priority||1,10),this.options=Object.assign({},i,n),this.cacheKeyMethod=this.defaultCacheKeys,this}return ut(r,[{key:"isConstant",value:function(){return this.type===this.constructor.CONSTANT}},{key:"isDynamic",value:function(){return this.type===this.constructor.DYNAMIC}},{key:"calculate",value:function(t,n){return Object.prototype.hasOwnProperty.call(this,"value")?this.value:this.calculationMethod(t,n)}},{key:"defaultCacheKeys",value:function(t,n){return{params:n,id:t}}},{key:"getCacheKey",value:function(t){if(this.options.cache===!0){var n=this.cacheKeyMethod(this.id,t),i=r.hashFromObject(n);return i}}}],[{key:"hashFromObject",value:function(t){return(0,ft.default)(t)}}]),r}();Re.CONSTANT="CONSTANT",Re.DYNAMIC="DYNAMIC",ye.default=Re;var Oe={},Te={},he={};Object.defineProperty(he,"__esModule",{value:!0}),he.default=dt;function dt(r){try{(typeof process<"u"&&process.env&&process.env.DEBUG&&process.env.DEBUG.match(/json-rules-engine/)||typeof window<"u"&&window.localStorage&&window.localStorage.debug&&window.localStorage.debug.match(/json-rules-engine/))&&console.log(r)}catch{}}function vt(r){return!!r&&typeof r=="object"}var We=vt;Object.defineProperty(Te,"__esModule",{value:!0});var pt=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),yt=he,mt=Ke(yt),gt=We,_t=Ke(gt);function Ke(r){return r&&r.__esModule?r:{default:r}}function bt(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var wt=function(){function r(e){if(bt(this,r),!e)throw new Error("Condition: constructor options required");var t=r.booleanOperator(e);if(Object.assign(this,e),t){var n=e[t];if(!Array.isArray(n))throw new Error('"'+t+'" must be an array');this.operator=t,this.priority=parseInt(e.priority,10)||1,this[t]=n.map(function(i){return new r(i)})}else{if(!Object.prototype.hasOwnProperty.call(e,"fact"))throw new Error('Condition: constructor "fact" property required');if(!Object.prototype.hasOwnProperty.call(e,"operator"))throw new Error('Condition: constructor "operator" property required');if(!Object.prototype.hasOwnProperty.call(e,"value"))throw new Error('Condition: constructor "value" property required');Object.prototype.hasOwnProperty.call(e,"priority")&&(e.priority=parseInt(e.priority,10))}}return pt(r,[{key:"toJSON",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={};this.priority&&(n.priority=this.priority);var i=r.booleanOperator(this);return i?n[i]=this[i].map(function(l){return l.toJSON(t)}):(n.operator=this.operator,n.value=this.value,n.fact=this.fact,this.factResult!==void 0&&(n.factResult=this.factResult),this.result!==void 0&&(n.result=this.result),this.params&&(n.params=this.params),this.path&&(n.path=this.path)),t?JSON.stringify(n):n}},{key:"_getValue",value:function(t){var n=this.value;return(0,_t.default)(n)&&Object.prototype.hasOwnProperty.call(n,"fact")?t.factValue(n.fact,n.params,n.path):Promise.resolve(n)}},{key:"evaluate",value:function(t,n){var i=this;if(!t)return Promise.reject(new Error("almanac required"));if(!n)return Promise.reject(new Error("operatorMap required"));if(this.isBooleanOperator())return Promise.reject(new Error("Cannot evaluate() a boolean condition"));var l=n.get(this.operator);return l?this._getValue(t).then(function(f){return t.factValue(i.fact,i.params,i.path).then(function(y){var w=l.evaluate(y,f);return(0,mt.default)("condition::evaluate <"+JSON.stringify(y)+" "+i.operator+" "+JSON.stringify(f)+"?> ("+w+")"),{result:w,leftHandSideValue:y,rightHandSideValue:f,operator:i.operator}})}):Promise.reject(new Error("Unknown operator: "+this.operator))}},{key:"booleanOperator",value:function(){return r.booleanOperator(this)}},{key:"isBooleanOperator",value:function(){return r.booleanOperator(this)!==void 0}}],[{key:"booleanOperator",value:function(t){if(Object.prototype.hasOwnProperty.call(t,"any"))return"any";if(Object.prototype.hasOwnProperty.call(t,"all"))return"all"}}]),r}();Te.default=wt;var ke={},Xe={exports:{}};(function(r){var e=function(){function t(E,_){return _!=null&&E instanceof _}var n;try{n=Map}catch{n=function(){}}var i;try{i=Set}catch{i=function(){}}var l;try{l=Promise}catch{l=function(){}}function f(E,_,T,j,M){typeof _=="object"&&(T=_.depth,j=_.prototype,M=_.includeNonEnumerable,_=_.circular);var q=[],G=[],te=typeof Buffer<"u";typeof _>"u"&&(_=!0),typeof T>"u"&&(T=1/0);function V(S,B){if(S===null)return null;if(B===0)return S;var k,Y;if(typeof S!="object")return S;if(t(S,n))k=new n;else if(t(S,i))k=new i;else if(t(S,l))k=new l(function(x,a){S.then(function(o){x(V(o,B-1))},function(o){a(V(o,B-1))})});else if(f.__isArray(S))k=[];else if(f.__isRegExp(S))k=new RegExp(S.source,F(S)),S.lastIndex&&(k.lastIndex=S.lastIndex);else if(f.__isDate(S))k=new Date(S.getTime());else{if(te&&Buffer.isBuffer(S))return Buffer.allocUnsafe?k=Buffer.allocUnsafe(S.length):k=new Buffer(S.length),S.copy(k),k;t(S,Error)?k=Object.create(S):typeof j>"u"?(Y=Object.getPrototypeOf(S),k=Object.create(Y)):(k=Object.create(j),Y=j)}if(_){var C=q.indexOf(S);if(C!=-1)return G[C];q.push(S),G.push(k)}t(S,n)&&S.forEach(function(x,a){var o=V(a,B-1),u=V(x,B-1);k.set(o,u)}),t(S,i)&&S.forEach(function(x){var a=V(x,B-1);k.add(a)});for(var D in S){var z;Y&&(z=Object.getOwnPropertyDescriptor(Y,D)),!(z&&z.set==null)&&(k[D]=V(S[D],B-1))}if(Object.getOwnPropertySymbols)for(var Q=Object.getOwnPropertySymbols(S),D=0;D<Q.length;D++){var J=Q[D],H=Object.getOwnPropertyDescriptor(S,J);H&&!H.enumerable&&!M||(k[J]=V(S[J],B-1),H.enumerable||Object.defineProperty(k,J,{enumerable:!1}))}if(M)for(var P=Object.getOwnPropertyNames(S),D=0;D<P.length;D++){var W=P[D],H=Object.getOwnPropertyDescriptor(S,W);H&&H.enumerable||(k[W]=V(S[W],B-1),Object.defineProperty(k,W,{enumerable:!1}))}return k}return V(E,T)}f.clonePrototype=function(_){if(_===null)return null;var T=function(){};return T.prototype=_,new T};function y(E){return Object.prototype.toString.call(E)}f.__objToStr=y;function w(E){return typeof E=="object"&&y(E)==="[object Date]"}f.__isDate=w;function R(E){return typeof E=="object"&&y(E)==="[object Array]"}f.__isArray=R;function b(E){return typeof E=="object"&&y(E)==="[object RegExp]"}f.__isRegExp=b;function F(E){var _="";return E.global&&(_+="g"),E.ignoreCase&&(_+="i"),E.multiline&&(_+="m"),_}return f.__getRegExpFlags=F,f}();r.exports&&(r.exports=e)})(Xe),Object.defineProperty(ke,"__esModule",{value:!0});var Et=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),Ot=Xe.exports,Fe=Ft(Ot);function Ft(r){return r&&r.__esModule?r:{default:r}}function St(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var Pt=function(){function r(e,t,n,i){St(this,r),this.conditions=(0,Fe.default)(e),this.event=(0,Fe.default)(t),this.priority=(0,Fe.default)(n),this.name=(0,Fe.default)(i),this.result=null}return Et(r,[{key:"setResult",value:function(t){this.result=t}},{key:"toJSON",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={conditions:this.conditions.toJSON(!1),event:this.event,priority:this.priority,name:this.name,result:this.result};return t?JSON.stringify(n):n}}]),r}();ke.default=Pt;var je={exports:{}};(function(r,e){(function(t){var n=Object.hasOwnProperty,i=Array.isArray?Array.isArray:function(o){return Object.prototype.toString.call(o)==="[object Array]"},l=10,f=typeof process=="object"&&typeof process.nextTick=="function",y=typeof Symbol=="function",w=typeof Reflect=="object",R=typeof setImmediate=="function",b=R?setImmediate:setTimeout,F=y?w&&typeof Reflect.ownKeys=="function"?Reflect.ownKeys:function(a){var o=Object.getOwnPropertyNames(a);return o.push.apply(o,Object.getOwnPropertySymbols(a)),o}:Object.keys;function E(){this._events={},this._conf&&_.call(this,this._conf)}function _(a){a&&(this._conf=a,a.delimiter&&(this.delimiter=a.delimiter),a.maxListeners!==t&&(this._maxListeners=a.maxListeners),a.wildcard&&(this.wildcard=a.wildcard),a.newListener&&(this._newListener=a.newListener),a.removeListener&&(this._removeListener=a.removeListener),a.verboseMemoryLeak&&(this.verboseMemoryLeak=a.verboseMemoryLeak),a.ignoreErrors&&(this.ignoreErrors=a.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function T(a,o){var u="(node) warning: possible EventEmitter memory leak detected. "+a+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(u+=" Event name: "+o+"."),typeof process<"u"&&process.emitWarning){var c=new Error(u);c.name="MaxListenersExceededWarning",c.emitter=this,c.count=a,process.emitWarning(c)}else console.error(u),console.trace&&console.trace()}var j=function(a,o,u){var c=arguments.length;switch(c){case 0:return[];case 1:return[a];case 2:return[a,o];case 3:return[a,o,u];default:for(var v=new Array(c);c--;)v[c]=arguments[c];return v}};function M(a,o){for(var u={},c,v=a.length,p=o?o.length:0,m=0;m<v;m++)c=a[m],u[c]=m<p?o[m]:t;return u}function q(a,o,u){this._emitter=a,this._target=o,this._listeners={},this._listenersCount=0;var c,v;if((u.on||u.off)&&(c=u.on,v=u.off),o.addEventListener?(c=o.addEventListener,v=o.removeEventListener):o.addListener?(c=o.addListener,v=o.removeListener):o.on&&(c=o.on,v=o.off),!c&&!v)throw Error("target does not implement any known event API");if(typeof c!="function")throw TypeError("on method must be a function");if(typeof v!="function")throw TypeError("off method must be a function");this._on=c,this._off=v;var p=a._observers;p?p.push(this):a._observers=[this]}Object.assign(q.prototype,{subscribe:function(a,o,u){var c=this,v=this._target,p=this._emitter,m=this._listeners,s=function(){var h=j.apply(null,arguments),d={data:h,name:o,original:a};if(u){var g=u.call(v,d);g!==!1&&p.emit.apply(p,[d.name].concat(h));return}p.emit.apply(p,[o].concat(h))};if(m[a])throw Error("Event '"+a+"' is already listening");this._listenersCount++,p._newListener&&p._removeListener&&!c._onNewListener?(this._onNewListener=function(h){h===o&&m[a]===null&&(m[a]=s,c._on.call(v,a,s))},p.on("newListener",this._onNewListener),this._onRemoveListener=function(h){h===o&&!p.hasListeners(h)&&m[a]&&(m[a]=null,c._off.call(v,a,s))},m[a]=null,p.on("removeListener",this._onRemoveListener)):(m[a]=s,c._on.call(v,a,s))},unsubscribe:function(a){var o=this,u=this._listeners,c=this._emitter,v,p,m=this._off,s=this._target,h;if(a&&typeof a!="string")throw TypeError("event must be a string");function d(){o._onNewListener&&(c.off("newListener",o._onNewListener),c.off("removeListener",o._onRemoveListener),o._onNewListener=null,o._onRemoveListener=null);var g=Y.call(c,o);c._observers.splice(g,1)}if(a){if(v=u[a],!v)return;m.call(s,a,v),delete u[a],--this._listenersCount||d()}else{for(p=F(u),h=p.length;h-- >0;)a=p[h],m.call(s,a,u[a]);this._listeners={},this._listenersCount=0,d()}}});function G(a,o,u,c){var v=Object.assign({},o);if(!a)return v;if(typeof a!="object")throw TypeError("options must be an object");var p=Object.keys(a),m=p.length,s,h,d;function g(O){throw Error('Invalid "'+s+'" option value'+(O?". Reason: "+O:""))}for(var A=0;A<m;A++){if(s=p[A],!c&&!n.call(o,s))throw Error('Unknown "'+s+'" option');h=a[s],h!==t&&(d=u[s],v[s]=d?d(h,g):h)}return v}function te(a,o){return(typeof a!="function"||!a.hasOwnProperty("prototype"))&&o("value must be a constructor"),a}function V(a){var o="value must be type of "+a.join("|"),u=a.length,c=a[0],v=a[1];return u===1?function(p,m){if(typeof p===c)return p;m(o)}:u===2?function(p,m){var s=typeof p;if(s===c||s===v)return p;m(o)}:function(p,m){for(var s=typeof p,h=u;h-- >0;)if(s===a[h])return p;m(o)}}var S=V(["function"]),B=V(["object","function"]);function k(a,o,u){var c,v,p=0,m,s=new a(function(h,d,g){u=G(u,{timeout:0,overload:!1},{timeout:function(L,K){return L*=1,(typeof L!="number"||L<0||!Number.isFinite(L))&&K("timeout must be a positive number"),L}}),c=!u.overload&&typeof a.prototype.cancel=="function"&&typeof g=="function";function A(){v&&(v=null),p&&(clearTimeout(p),p=0)}var O=function(L){A(),h(L)},I=function(L){A(),d(L)};c?o(O,I,g):(v=[function(L){I(L||Error("canceled"))}],o(O,I,function(L){if(m)throw Error("Unable to subscribe on cancel event asynchronously");if(typeof L!="function")throw TypeError("onCancel callback must be a function");v.push(L)}),m=!0),u.timeout>0&&(p=setTimeout(function(){var L=Error("timeout");L.code="ETIMEDOUT",p=0,s.cancel(L),d(L)},u.timeout))});return c||(s.cancel=function(h){if(!!v){for(var d=v.length,g=1;g<d;g++)v[g](h);v[0](h),v=null}}),s}function Y(a){var o=this._observers;if(!o)return-1;for(var u=o.length,c=0;c<u;c++)if(o[c]._target===a)return c;return-1}function C(a,o,u,c,v){if(!u)return null;if(c===0){var p=typeof o;if(p==="string"){var m,s,h=0,d=0,g=this.delimiter,A=g.length;if((s=o.indexOf(g))!==-1){m=new Array(5);do m[h++]=o.slice(d,s),d=s+A;while((s=o.indexOf(g,d))!==-1);m[h++]=o.slice(d),o=m,v=h}else o=[o],v=1}else p==="object"?v=o.length:(o=[o],v=1)}var O=null,I,L,K,Je,ze,Ee=o[c],He=o[c+1],ue,ee;if(c===v)u._listeners&&(typeof u._listeners=="function"?(a&&a.push(u._listeners),O=[u]):(a&&a.push.apply(a,u._listeners),O=[u]));else if(Ee==="*"){for(ue=F(u),s=ue.length;s-- >0;)I=ue[s],I!=="_listeners"&&(ee=C(a,o,u[I],c+1,v),ee&&(O?O.push.apply(O,ee):O=ee));return O}else if(Ee==="**"){for(ze=c+1===v||c+2===v&&He==="*",ze&&u._listeners&&(O=C(a,o,u,v,v)),ue=F(u),s=ue.length;s-- >0;)I=ue[s],I!=="_listeners"&&(I==="*"||I==="**"?(u[I]._listeners&&!ze&&(ee=C(a,o,u[I],v,v),ee&&(O?O.push.apply(O,ee):O=ee)),ee=C(a,o,u[I],c,v)):I===He?ee=C(a,o,u[I],c+2,v):ee=C(a,o,u[I],c,v),ee&&(O?O.push.apply(O,ee):O=ee));return O}else u[Ee]&&(O=C(a,o,u[Ee],c+1,v));if(L=u["*"],L&&C(a,o,L,c+1,v),K=u["**"],K)if(c<v)for(K._listeners&&C(a,o,K,v,v),ue=F(K),s=ue.length;s-- >0;)I=ue[s],I!=="_listeners"&&(I===He?C(a,o,K[I],c+2,v):I===Ee?C(a,o,K[I],c+1,v):(Je={},Je[I]=K[I],C(a,o,{"**":Je},c+1,v)));else K._listeners?C(a,o,K,v,v):K["*"]&&K["*"]._listeners&&C(a,o,K["*"],v,v);return O}function D(a,o,u){var c=0,v=0,p,m=this.delimiter,s=m.length,h;if(typeof a=="string")if((p=a.indexOf(m))!==-1){h=new Array(5);do h[c++]=a.slice(v,p),v=p+s;while((p=a.indexOf(m,v))!==-1);h[c++]=a.slice(v)}else h=[a],c=1;else h=a,c=a.length;if(c>1){for(p=0;p+1<c;p++)if(h[p]==="**"&&h[p+1]==="**")return}var d=this.listenerTree,g;for(p=0;p<c;p++)if(g=h[p],d=d[g]||(d[g]={}),p===c-1)return d._listeners?(typeof d._listeners=="function"&&(d._listeners=[d._listeners]),u?d._listeners.unshift(o):d._listeners.push(o),!d._listeners.warned&&this._maxListeners>0&&d._listeners.length>this._maxListeners&&(d._listeners.warned=!0,T.call(this,d._listeners.length,g))):d._listeners=o,!0;return!0}function z(a,o,u,c){for(var v=F(a),p=v.length,m,s,h,d=a._listeners,g;p-- >0;)s=v[p],m=a[s],s==="_listeners"?h=u:h=u?u.concat(s):[s],g=c||typeof s=="symbol",d&&o.push(g?h:h.join(this.delimiter)),typeof m=="object"&&z.call(this,m,o,h,g);return o}function Q(a){for(var o=F(a),u=o.length,c,v,p;u-- >0;)v=o[u],c=a[v],c&&(p=!0,v!=="_listeners"&&!Q(c)&&delete a[v]);return p}function J(a,o,u){this.emitter=a,this.event=o,this.listener=u}J.prototype.off=function(){return this.emitter.off(this.event,this.listener),this};function H(a,o,u){if(u===!0)v=!0;else if(u===!1)c=!0;else{if(!u||typeof u!="object")throw TypeError("options should be an object or true");var c=u.async,v=u.promisify,p=u.nextTick,m=u.objectify}if(c||p||v){var s=o,h=o._origin||o;if(p&&!f)throw Error("process.nextTick is not supported");v===t&&(v=o.constructor.name==="AsyncFunction"),o=function(){var d=arguments,g=this,A=this.event;return v?p?Promise.resolve():new Promise(function(O){b(O)}).then(function(){return g.event=A,s.apply(g,d)}):(p?process.nextTick:b)(function(){g.event=A,s.apply(g,d)})},o._async=!0,o._origin=h}return[o,m?new J(this,a,o):this]}function P(a){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,_.call(this,a)}P.EventEmitter2=P,P.prototype.listenTo=function(a,o,u){if(typeof a!="object")throw TypeError("target musts be an object");var c=this;u=G(u,{on:t,off:t,reducers:t},{on:S,off:S,reducers:B});function v(p){if(typeof p!="object")throw TypeError("events must be an object");var m=u.reducers,s=Y.call(c,a),h;s===-1?h=new q(c,a,u):h=c._observers[s];for(var d=F(p),g=d.length,A,O=typeof m=="function",I=0;I<g;I++)A=d[I],h.subscribe(A,p[A]||A,O?m:m&&m[A])}return i(o)?v(M(o)):v(typeof o=="string"?M(o.split(/\s+/)):o),this},P.prototype.stopListeningTo=function(a,o){var u=this._observers;if(!u)return!1;var c=u.length,v,p=!1;if(a&&typeof a!="object")throw TypeError("target should be an object");for(;c-- >0;)v=u[c],(!a||v._target===a)&&(v.unsubscribe(o),p=!0);return p},P.prototype.delimiter=".",P.prototype.setMaxListeners=function(a){a!==t&&(this._maxListeners=a,this._conf||(this._conf={}),this._conf.maxListeners=a)},P.prototype.getMaxListeners=function(){return this._maxListeners},P.prototype.event="",P.prototype.once=function(a,o,u){return this._once(a,o,!1,u)},P.prototype.prependOnceListener=function(a,o,u){return this._once(a,o,!0,u)},P.prototype._once=function(a,o,u,c){return this._many(a,1,o,u,c)},P.prototype.many=function(a,o,u,c){return this._many(a,o,u,!1,c)},P.prototype.prependMany=function(a,o,u,c){return this._many(a,o,u,!0,c)},P.prototype._many=function(a,o,u,c,v){var p=this;if(typeof u!="function")throw new Error("many only accepts instances of Function");function m(){return--o===0&&p.off(a,m),u.apply(this,arguments)}return m._origin=u,this._on(a,m,c,v)},P.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||E.call(this);var a=arguments[0],o,u=this.wildcard,c,v,p,m,s;if(a==="newListener"&&!this._newListener&&!this._events.newListener)return!1;if(u&&(o=a,a!=="newListener"&&a!=="removeListener"&&typeof a=="object")){if(v=a.length,y){for(p=0;p<v;p++)if(typeof a[p]=="symbol"){s=!0;break}}s||(a=a.join(this.delimiter))}var h=arguments.length,d;if(this._all&&this._all.length)for(d=this._all.slice(),p=0,v=d.length;p<v;p++)switch(this.event=a,h){case 1:d[p].call(this,a);break;case 2:d[p].call(this,a,arguments[1]);break;case 3:d[p].call(this,a,arguments[1],arguments[2]);break;default:d[p].apply(this,arguments)}if(u)d=[],C.call(this,d,o,this.listenerTree,0,v);else if(d=this._events[a],typeof d=="function"){switch(this.event=a,h){case 1:d.call(this);break;case 2:d.call(this,arguments[1]);break;case 3:d.call(this,arguments[1],arguments[2]);break;default:for(c=new Array(h-1),m=1;m<h;m++)c[m-1]=arguments[m];d.apply(this,c)}return!0}else d&&(d=d.slice());if(d&&d.length){if(h>3)for(c=new Array(h-1),m=1;m<h;m++)c[m-1]=arguments[m];for(p=0,v=d.length;p<v;p++)switch(this.event=a,h){case 1:d[p].call(this);break;case 2:d[p].call(this,arguments[1]);break;case 3:d[p].call(this,arguments[1],arguments[2]);break;default:d[p].apply(this,c)}return!0}else if(!this.ignoreErrors&&!this._all&&a==="error")throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},P.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||E.call(this);var a=arguments[0],o=this.wildcard,u,c,v,p,m,s;if(a==="newListener"&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(u=a,a!=="newListener"&&a!=="removeListener"&&typeof a=="object")){if(p=a.length,y){for(m=0;m<p;m++)if(typeof a[m]=="symbol"){c=!0;break}}c||(a=a.join(this.delimiter))}var h=[],d=arguments.length,g;if(this._all)for(m=0,p=this._all.length;m<p;m++)switch(this.event=a,d){case 1:h.push(this._all[m].call(this,a));break;case 2:h.push(this._all[m].call(this,a,arguments[1]));break;case 3:h.push(this._all[m].call(this,a,arguments[1],arguments[2]));break;default:h.push(this._all[m].apply(this,arguments))}if(o?(g=[],C.call(this,g,u,this.listenerTree,0)):g=this._events[a],typeof g=="function")switch(this.event=a,d){case 1:h.push(g.call(this));break;case 2:h.push(g.call(this,arguments[1]));break;case 3:h.push(g.call(this,arguments[1],arguments[2]));break;default:for(v=new Array(d-1),s=1;s<d;s++)v[s-1]=arguments[s];h.push(g.apply(this,v))}else if(g&&g.length){if(g=g.slice(),d>3)for(v=new Array(d-1),s=1;s<d;s++)v[s-1]=arguments[s];for(m=0,p=g.length;m<p;m++)switch(this.event=a,d){case 1:h.push(g[m].call(this));break;case 2:h.push(g[m].call(this,arguments[1]));break;case 3:h.push(g[m].call(this,arguments[1],arguments[2]));break;default:h.push(g[m].apply(this,v))}}else if(!this.ignoreErrors&&!this._all&&a==="error")return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(h)},P.prototype.on=function(a,o,u){return this._on(a,o,!1,u)},P.prototype.prependListener=function(a,o,u){return this._on(a,o,!0,u)},P.prototype.onAny=function(a){return this._onAny(a,!1)},P.prototype.prependAny=function(a){return this._onAny(a,!0)},P.prototype.addListener=P.prototype.on,P.prototype._onAny=function(a,o){if(typeof a!="function")throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),o?this._all.unshift(a):this._all.push(a),this},P.prototype._on=function(a,o,u,c){if(typeof a=="function")return this._onAny(a,o),this;if(typeof o!="function")throw new Error("on only accepts instances of Function");this._events||E.call(this);var v=this,p;return c!==t&&(p=H.call(this,a,o,c),o=p[0],v=p[1]),this._newListener&&this.emit("newListener",a,o),this.wildcard?(D.call(this,a,o,u),v):(this._events[a]?(typeof this._events[a]=="function"&&(this._events[a]=[this._events[a]]),u?this._events[a].unshift(o):this._events[a].push(o),!this._events[a].warned&&this._maxListeners>0&&this._events[a].length>this._maxListeners&&(this._events[a].warned=!0,T.call(this,this._events[a].length,a))):this._events[a]=o,v)},P.prototype.off=function(a,o){if(typeof o!="function")throw new Error("removeListener only takes instances of Function");var u,c=[];if(this.wildcard){var v=typeof a=="string"?a.split(this.delimiter):a.slice();if(c=C.call(this,null,v,this.listenerTree,0),!c)return this}else{if(!this._events[a])return this;u=this._events[a],c.push({_listeners:u})}for(var p=0;p<c.length;p++){var m=c[p];if(u=m._listeners,i(u)){for(var s=-1,h=0,d=u.length;h<d;h++)if(u[h]===o||u[h].listener&&u[h].listener===o||u[h]._origin&&u[h]._origin===o){s=h;break}if(s<0)continue;return this.wildcard?m._listeners.splice(s,1):this._events[a].splice(s,1),u.length===0&&(this.wildcard?delete m._listeners:delete this._events[a]),this._removeListener&&this.emit("removeListener",a,o),this}else(u===o||u.listener&&u.listener===o||u._origin&&u._origin===o)&&(this.wildcard?delete m._listeners:delete this._events[a],this._removeListener&&this.emit("removeListener",a,o))}return this.listenerTree&&Q(this.listenerTree),this},P.prototype.offAny=function(a){var o=0,u=0,c;if(a&&this._all&&this._all.length>0){for(c=this._all,o=0,u=c.length;o<u;o++)if(a===c[o])return c.splice(o,1),this._removeListener&&this.emit("removeListenerAny",a),this}else{if(c=this._all,this._removeListener)for(o=0,u=c.length;o<u;o++)this.emit("removeListenerAny",c[o]);this._all=[]}return this},P.prototype.removeListener=P.prototype.off,P.prototype.removeAllListeners=function(a){if(a===t)return!this._events||E.call(this),this;if(this.wildcard){var o=C.call(this,null,a,this.listenerTree,0),u,c;if(!o)return this;for(c=0;c<o.length;c++)u=o[c],u._listeners=null;this.listenerTree&&Q(this.listenerTree)}else this._events&&(this._events[a]=null);return this},P.prototype.listeners=function(a){var o=this._events,u,c,v,p,m;if(a===t){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(u=F(o),p=u.length,v=[];p-- >0;)c=o[u[p]],typeof c=="function"?v.push(c):v.push.apply(v,c);return v}else{if(this.wildcard){if(m=this.listenerTree,!m)return[];var s=[],h=typeof a=="string"?a.split(this.delimiter):a.slice();return C.call(this,s,h,m,0),s}return o?(c=o[a],c?typeof c=="function"?[c]:c:[]):[]}},P.prototype.eventNames=function(a){var o=this._events;return this.wildcard?z.call(this,this.listenerTree,[],null,a):o?F(o):[]},P.prototype.listenerCount=function(a){return this.listeners(a).length},P.prototype.hasListeners=function(a){if(this.wildcard){var o=[],u=typeof a=="string"?a.split(this.delimiter):a.slice();return C.call(this,o,u,this.listenerTree,0),o.length>0}var c=this._events,v=this._all;return!!(v&&v.length||c&&(a===t?F(c).length:c[a]))},P.prototype.listenersAny=function(){return this._all?this._all:[]},P.prototype.waitFor=function(a,o){var u=this,c=typeof o;return c==="number"?o={timeout:o}:c==="function"&&(o={filter:o}),o=G(o,{timeout:0,filter:t,handleError:!1,Promise,overload:!1},{filter:S,Promise:te}),k(o.Promise,function(v,p,m){function s(){var h=o.filter;if(!(h&&!h.apply(u,arguments)))if(u.off(a,s),o.handleError){var d=arguments[0];d?p(d):v(j.apply(null,arguments).slice(1))}else v(j.apply(null,arguments))}m(function(){u.off(a,s)}),u._on(a,s,!1)},{timeout:o.timeout,overload:o.overload})};function W(a,o,u){u=G(u,{Promise,timeout:0,overload:!1},{Promise:te});var c=u.Promise;return k(c,function(v,p,m){var s;if(typeof a.addEventListener=="function"){s=function(){v(j.apply(null,arguments))},m(function(){a.removeEventListener(o,s)}),a.addEventListener(o,s,{once:!0});return}var h=function(){d&&a.removeListener("error",d),v(j.apply(null,arguments))},d;o!=="error"&&(d=function(g){a.removeListener(o,h),p(g)},a.once("error",d)),m(function(){d&&a.removeListener("error",d),a.removeListener(o,h)}),a.once(o,h)},{timeout:u.timeout,overload:u.overload})}var x=P.prototype;Object.defineProperties(P,{defaultMaxListeners:{get:function(){return x._maxListeners},set:function(a){if(typeof a!="number"||a<0||Number.isNaN(a))throw TypeError("n must be a non-negative number");x._maxListeners=a},enumerable:!0},once:{value:W,writable:!0,configurable:!0}}),Object.defineProperties(x,{_maxListeners:{value:l,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),typeof t=="function"&&t.amd?t(function(){return P}):r.exports=P})()})(je),Object.defineProperty(Oe,"__esModule",{value:!0});var At=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),Rt=Te,Tt=Se(Rt),kt=ke,jt=Se(kt),Dt=he,De=Se(Dt),It=je.exports,Ct=Se(It);function Se(r){return r&&r.__esModule?r:{default:r}}function Nt(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function $t(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Mt(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}var Lt=function(r){Mt(e,r);function e(t){Nt(this,e);var n=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));typeof t=="string"&&(t=JSON.parse(t)),t&&t.conditions&&n.setConditions(t.conditions),t&&t.onSuccess&&n.on("success",t.onSuccess),t&&t.onFailure&&n.on("failure",t.onFailure),t&&(t.name||t.name===0)&&n.setName(t.name);var i=t&&t.priority||1;n.setPriority(i);var l=t&&t.event||{type:"unknown"};return n.setEvent(l),n}return At(e,[{key:"setPriority",value:function(n){if(n=parseInt(n,10),n<=0)throw new Error("Priority must be greater than zero");return this.priority=n,this}},{key:"setName",value:function(n){if(!n&&n!==0)throw new Error('Rule "name" must be defined');return this.name=n,this}},{key:"setConditions",value:function(n){if(!Object.prototype.hasOwnProperty.call(n,"all")&&!Object.prototype.hasOwnProperty.call(n,"any"))throw new Error('"conditions" root must contain a single instance of "all" or "any"');return this.conditions=new Tt.default(n),this}},{key:"setEvent",value:function(n){if(!n)throw new Error("Rule: setEvent() requires event object");if(!Object.prototype.hasOwnProperty.call(n,"type"))throw new Error('Rule: setEvent() requires event object with "type" property');return this.ruleEvent={type:n.type},n.params&&(this.ruleEvent.params=n.params),this}},{key:"getEvent",value:function(){return this.ruleEvent}},{key:"getPriority",value:function(){return this.priority}},{key:"getConditions",value:function(){return this.conditions}},{key:"getEngine",value:function(){return this.engine}},{key:"setEngine",value:function(n){return this.engine=n,this}},{key:"toJSON",value:function(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i={conditions:this.conditions.toJSON(!1),priority:this.priority,event:this.ruleEvent,name:this.name};return n?JSON.stringify(i):i}},{key:"prioritizeConditions",value:function(n){var i=this,l=n.reduce(function(f,y){var w=y.priority;if(!w){var R=i.engine.getFact(y.fact);w=R&&R.priority||1}return f[w]||(f[w]=[]),f[w].push(y),f},{});return Object.keys(l).sort(function(f,y){return Number(f)>Number(y)?-1:1}).map(function(f){return l[f]})}},{key:"evaluate",value:function(n){var i=this,l=new jt.default(this.conditions,this.ruleEvent,this.priority,this.name),f=function(_){if(_.isBooleanOperator()){var T=_[_.operator],j=void 0;return _.operator==="all"?j=b(T):j=R(T),j.then(function(M){var q=M===!0;return _.result=q,q})}else return _.evaluate(n,i.engine.operators).then(function(M){var q=M.result;return _.factResult=M.leftHandSideValue,_.result=q,q})},y=function(_,T){return Array.isArray(_)||(_=[_]),Promise.all(_.map(function(j){return f(j)})).then(function(j){return(0,De.default)("rule::evaluateConditions results",j),T.call(j,function(M){return M===!0})})},w=function(_,T){if(_.length===0)return Promise.resolve(!0);var j=Array.prototype.some;T==="all"&&(j=Array.prototype.every);for(var M=i.prioritizeConditions(_),q=Promise.resolve(),G=function(S){var B=M[S],k=!1;q=q.then(function(Y){return T==="any"&&Y===!0||k?((0,De.default)("prioritizeAndRun::detected truthy result; skipping remaining conditions"),k=!0,!0):T==="all"&&Y===!1||k?((0,De.default)("prioritizeAndRun::detected falsey result; skipping remaining conditions"),k=!0,!1):y(B,j)})},te=0;te<M.length;te++)G(te);return q},R=function(_){return w(_,"any")},b=function(_){return w(_,"all")},F=function(_){l.setResult(_);var T=_?"success":"failure";return i.emitAsync(T,l.event,n,l).then(function(){return l})};return l.conditions.any?R(l.conditions.any).then(function(E){return F(E)}):b(l.conditions.all).then(function(E){return F(E)})}}]),e}(Ct.default);Oe.default=Lt;var me={};Object.defineProperty(me,"__esModule",{value:!0});var qt=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function Bt(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}var xt=function(){function r(e,t,n){if(Bt(this,r),this.name=String(e),!e)throw new Error("Missing operator name");if(typeof t!="function")throw new Error("Missing operator callback");this.cb=t,this.factValueValidator=n,this.factValueValidator||(this.factValueValidator=function(){return!0})}return qt(r,[{key:"evaluate",value:function(t,n){return this.factValueValidator(t)&&this.cb(t,n)}}]),r}();me.default=xt;var Ie={},Ce={};Object.defineProperty(Ce,"__esModule",{value:!0});function Ut(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Vt(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Jt(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}Ce.UndefinedFactError=function(r){Jt(e,r);function e(){var t;Ut(this,e);for(var n=arguments.length,i=Array(n),l=0;l<n;l++)i[l]=arguments[l];var f=Vt(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(i)));return f.code="UNDEFINED_FACT",f}return e}(Error);function ne(r){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ne=function(e){return typeof e}:ne=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ne(r)}function zt(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Ht(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),e&&_e(r,e)}function ge(r){return ge=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},ge(r)}function _e(r,e){return _e=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},_e(r,e)}function Ze(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function be(r,e,t){return Ze()?be=Reflect.construct:be=function(i,l,f){var y=[null];y.push.apply(y,l);var w=Function.bind.apply(i,y),R=new w;return f&&_e(R,f.prototype),R},be.apply(null,arguments)}function Gt(r){return Function.toString.call(r).indexOf("[native code]")!==-1}function Ne(r){var e=typeof Map=="function"?new Map:void 0;return Ne=function(n){if(n===null||!Gt(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,i)}function i(){return be(n,arguments,ge(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),_e(i,n)},Ne(r)}function Yt(r){if(r===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return r}function Wt(r,e){return e&&(typeof e=="object"||typeof e=="function")?e:Yt(r)}function Kt(r){var e=Ze();return function(){var n=ge(r),i;if(e){var l=ge(this).constructor;i=Reflect.construct(n,arguments,l)}else i=n.apply(this,arguments);return Wt(this,i)}}function Qe(r){return Xt(r)||Zt(r)||et(r)||Qt()}function Xt(r){if(Array.isArray(r))return $e(r)}function Zt(r){if(typeof Symbol<"u"&&r[Symbol.iterator]!=null||r["@@iterator"]!=null)return Array.from(r)}function et(r,e){if(!!r){if(typeof r=="string")return $e(r,e);var t=Object.prototype.toString.call(r).slice(8,-1);if(t==="Object"&&r.constructor&&(t=r.constructor.name),t==="Map"||t==="Set")return Array.from(r);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return $e(r,e)}}function $e(r,e){(e==null||e>r.length)&&(e=r.length);for(var t=0,n=new Array(e);t<e;t++)n[t]=r[t];return n}function Qt(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function er(r,e){var t=typeof Symbol<"u"&&r[Symbol.iterator]||r["@@iterator"];if(!t){if(Array.isArray(r)||(t=et(r))||e&&r&&typeof r.length=="number"){t&&(r=t);var n=0,i=function(){};return{s:i,n:function(){return n>=r.length?{done:!0}:{done:!1,value:r[n++]}},e:function(w){throw w},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var l=!0,f=!1,y;return{s:function(){t=t.call(r)},n:function(){var w=t.next();return l=w.done,w},e:function(w){f=!0,y=w},f:function(){try{!l&&t.return!=null&&t.return()}finally{if(f)throw y}}}}var Z=Object.prototype.hasOwnProperty;function we(r,e){return r=r.slice(),r.push(e),r}function de(r,e){return e=e.slice(),e.unshift(r),e}var tr=function(r){Ht(t,r);var e=Kt(t);function t(n){var i;return zt(this,t),i=e.call(this,'JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),i.avoidNew=!0,i.value=n,i.name="NewError",i}return t}(Ne(Error));function $(r,e,t,n,i){if(!(this instanceof $))try{return new $(r,e,t,n,i)}catch(w){if(!w.avoidNew)throw w;return w.value}typeof r=="string"&&(i=n,n=t,t=e,e=r,r=null);var l=r&&ne(r)==="object";if(r=r||{},this.json=r.json||t,this.path=r.path||e,this.resultType=r.resultType||"value",this.flatten=r.flatten||!1,this.wrap=Z.call(r,"wrap")?r.wrap:!0,this.sandbox=r.sandbox||{},this.preventEval=r.preventEval||!1,this.parent=r.parent||null,this.parentProperty=r.parentProperty||null,this.callback=r.callback||n||null,this.otherTypeCallback=r.otherTypeCallback||i||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},r.autostart!==!1){var f={path:l?r.path:e};l?"json"in r&&(f.json=r.json):f.json=t;var y=this.evaluate(f);if(!y||ne(y)!=="object")throw new tr(y);return y}}$.prototype.evaluate=function(r,e,t,n){var i=this,l=this.parent,f=this.parentProperty,y=this.flatten,w=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,t=t||this.callback,this.currOtherTypeCallback=n||this.otherTypeCallback,e=e||this.json,r=r||this.path,r&&ne(r)==="object"&&!Array.isArray(r)){if(!r.path&&r.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Z.call(r,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');var R=r;e=R.json,y=Z.call(r,"flatten")?r.flatten:y,this.currResultType=Z.call(r,"resultType")?r.resultType:this.currResultType,this.currSandbox=Z.call(r,"sandbox")?r.sandbox:this.currSandbox,w=Z.call(r,"wrap")?r.wrap:w,this.currPreventEval=Z.call(r,"preventEval")?r.preventEval:this.currPreventEval,t=Z.call(r,"callback")?r.callback:t,this.currOtherTypeCallback=Z.call(r,"otherTypeCallback")?r.otherTypeCallback:this.currOtherTypeCallback,l=Z.call(r,"parent")?r.parent:l,f=Z.call(r,"parentProperty")?r.parentProperty:f,r=r.path}if(l=l||null,f=f||null,Array.isArray(r)&&(r=$.toPathString(r)),!(!r&&r!==""||!e)){var b=$.toPathArray(r);b[0]==="$"&&b.length>1&&b.shift(),this._hasParentSelector=null;var F=this._trace(b,e,["$"],l,f,t).filter(function(E){return E&&!E.isParentSelector});return F.length?!w&&F.length===1&&!F[0].hasArrExpr?this._getPreferredOutput(F[0]):F.reduce(function(E,_){var T=i._getPreferredOutput(_);return y&&Array.isArray(T)?E=E.concat(T):E.push(T),E},[]):w?[]:void 0}},$.prototype._getPreferredOutput=function(r){var e=this.currResultType;switch(e){case"all":{var t=Array.isArray(r.path)?r.path:$.toPathArray(r.path);return r.pointer=$.toPointer(t),r.path=typeof r.path=="string"?r.path:$.toPathString(r.path),r}case"value":case"parent":case"parentProperty":return r[e];case"path":return $.toPathString(r[e]);case"pointer":return $.toPointer(r.path);default:throw new TypeError("Unknown result type")}},$.prototype._handleCallback=function(r,e,t){if(e){var n=this._getPreferredOutput(r);r.path=typeof r.path=="string"?r.path:$.toPathString(r.path),e(n,t,r)}},$.prototype._trace=function(r,e,t,n,i,l,f,y){var w=this,R;if(!r.length)return R={path:t,value:e,parent:n,parentProperty:i,hasArrExpr:f},this._handleCallback(R,l,"value"),R;var b=r[0],F=r.slice(1),E=[];function _(D){Array.isArray(D)?D.forEach(function(z){E.push(z)}):E.push(D)}if((typeof b!="string"||y)&&e&&Z.call(e,b))_(this._trace(F,e[b],we(t,b),e,b,l,f));else if(b==="*")this._walk(b,F,e,t,n,i,l,function(D,z,Q,J,H,P,W,x){_(w._trace(de(D,Q),J,H,P,W,x,!0,!0))});else if(b==="..")_(this._trace(F,e,t,n,i,l,f)),this._walk(b,F,e,t,n,i,l,function(D,z,Q,J,H,P,W,x){ne(J[D])==="object"&&_(w._trace(de(z,Q),J[D],we(H,D),J,D,x,!0))});else{if(b==="^")return this._hasParentSelector=!0,{path:t.slice(0,-1),expr:F,isParentSelector:!0};if(b==="~")return R={path:we(t,b),value:i,parent:n,parentProperty:null},this._handleCallback(R,l,"property"),R;if(b==="$")_(this._trace(F,e,t,null,null,l,f));else if(/^(\x2D?[0-9]*):(\x2D?[0-9]*):?([0-9]*)$/.test(b))_(this._slice(b,F,e,t,n,i,l));else if(b.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");this._walk(b,F,e,t,n,i,l,function(D,z,Q,J,H,P,W,x){w._eval(z.replace(/^\?\(((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?)\)$/,"$1"),J[D],D,H,P,W)&&_(w._trace(de(D,Q),J,H,P,W,x,!0))})}else if(b[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");_(this._trace(de(this._eval(b,e,t[t.length-1],t.slice(0,-1),n,i),F),e,t,n,i,l,f))}else if(b[0]==="@"){var T=!1,j=b.slice(1,-2);switch(j){case"scalar":(!e||!["object","function"].includes(ne(e)))&&(T=!0);break;case"boolean":case"string":case"undefined":case"function":ne(e)===j&&(T=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(T=!0);break;case"number":Number.isFinite(e)&&(T=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(T=!0);break;case"object":e&&ne(e)===j&&(T=!0);break;case"array":Array.isArray(e)&&(T=!0);break;case"other":T=this.currOtherTypeCallback(e,t,n,i);break;case"null":e===null&&(T=!0);break;default:throw new TypeError("Unknown value type "+j)}if(T)return R={path:t,value:e,parent:n,parentProperty:i},this._handleCallback(R,l,"value"),R}else if(b[0]==="`"&&e&&Z.call(e,b.slice(1))){var M=b.slice(1);_(this._trace(F,e[M],we(t,M),e,M,l,f,!0))}else if(b.includes(",")){var q=b.split(","),G=er(q),te;try{for(G.s();!(te=G.n()).done;){var V=te.value;_(this._trace(de(V,F),e,t,n,i,l,!0))}}catch(D){G.e(D)}finally{G.f()}}else!y&&e&&Z.call(e,b)&&_(this._trace(F,e[b],we(t,b),e,b,l,f,!0))}if(this._hasParentSelector)for(var S=0;S<E.length;S++){var B=E[S];if(B&&B.isParentSelector){var k=this._trace(B.expr,e,B.path,n,i,l,f);if(Array.isArray(k)){E[S]=k[0];for(var Y=k.length,C=1;C<Y;C++)S++,E.splice(S,0,k[C])}else E[S]=k}}return E},$.prototype._walk=function(r,e,t,n,i,l,f,y){if(Array.isArray(t))for(var w=t.length,R=0;R<w;R++)y(R,r,e,t,n,i,l,f);else t&&ne(t)==="object"&&Object.keys(t).forEach(function(b){y(b,r,e,t,n,i,l,f)})},$.prototype._slice=function(r,e,t,n,i,l,f){if(!!Array.isArray(t)){var y=t.length,w=r.split(":"),R=w[2]&&Number.parseInt(w[2])||1,b=w[0]&&Number.parseInt(w[0])||0,F=w[1]&&Number.parseInt(w[1])||y;b=b<0?Math.max(0,b+y):Math.min(y,b),F=F<0?Math.max(0,F+y):Math.min(y,F);for(var E=[],_=b;_<F;_+=R){var T=this._trace(de(_,e),t,n,i,l,f,!0);T.forEach(function(j){E.push(j)})}return E}},$.prototype._eval=function(r,e,t,n,i,l){r.includes("@parentProperty")&&(this.currSandbox._$_parentProperty=l,r=r.replace(/@parentProperty/g,"_$_parentProperty")),r.includes("@parent")&&(this.currSandbox._$_parent=i,r=r.replace(/@parent/g,"_$_parent")),r.includes("@property")&&(this.currSandbox._$_property=t,r=r.replace(/@property/g,"_$_property")),r.includes("@path")&&(this.currSandbox._$_path=$.toPathString(n.concat([t])),r=r.replace(/@path/g,"_$_path")),r.includes("@root")&&(this.currSandbox._$_root=this.json,r=r.replace(/@root/g,"_$_root")),/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/.test(r)&&(this.currSandbox._$_v=e,r=r.replace(/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/g,"_$_v$1"));try{return this.vm.runInNewContext(r,this.currSandbox)}catch(f){throw console.log(f),new Error("jsonPath: "+f.message+": "+r)}},$.cache={},$.toPathString=function(r){for(var e=r,t=e.length,n="$",i=1;i<t;i++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[i])||(n+=/^[\*0-9]+$/.test(e[i])?"["+e[i]+"]":"['"+e[i]+"']");return n},$.toPointer=function(r){for(var e=r,t=e.length,n="",i=1;i<t;i++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[i])||(n+="/"+e[i].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return n},$.toPathArray=function(r){var e=$.cache;if(e[r])return e[r].concat();var t=[],n=r.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))['\]]/g,function(l,f){return"[#"+(t.push(f)-1)+"]"}).replace(/\[["']((?:(?!['\]])[\s\S])*)["']\]/g,function(l,f){return"['"+f.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/["']?\.["']?(?!(?:(?!\[)[\s\S])*\])|\[["']?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(l,f){return";"+f.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),i=n.split(";").map(function(l){var f=l.match(/#([0-9]+)/);return!f||!f[1]?l:t[f[1]]});return e[r]=i,e[r].concat()};var rr=function(e,t,n){for(var i=e.length,l=0;l<i;l++){var f=e[l];n(f)&&t.push(e.splice(l--,1)[0])}};$.prototype.vm={runInNewContext:function(e,t){var n=Object.keys(t),i=[];rr(n,i,function(R){return typeof t[R]=="function"});var l=n.map(function(R,b){return t[R]}),f=i.reduce(function(R,b){var F=t[b].toString();return/function/.test(F)||(F="function "+F),"var "+b+"="+F+";"+R},"");e=f+e,!/(["'])use strict\1/.test(e)&&!n.includes("arguments")&&(e="var arguments = undefined;"+e),e=e.replace(/;[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*$/,"");var y=e.lastIndexOf(";"),w=y>-1?e.slice(0,y+1)+" return "+e.slice(y+1):" return "+e;return be(Function,Qe(n).concat([w])).apply(void 0,Qe(l))}};const nr=st(Object.freeze(Object.defineProperty({__proto__:null,JSONPath:$},Symbol.toStringTag,{value:"Module"})));Object.defineProperty(Ie,"__esModule",{value:!0});var tt=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},ir=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),ar=ye,Me=Le(ar),or=Ce,sr=he,fe=Le(sr),ur=nr,lr=We,fr=Le(lr);function Le(r){return r&&r.__esModule?r:{default:r}}function cr(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function hr(r,e){return(0,ur.JSONPath)({path:e,json:r,wrap:!1})}var dr=function(){function r(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};cr(this,r),this.factMap=new Map(e),this.factResultsCache=new Map,this.allowUndefinedFacts=Boolean(n.allowUndefinedFacts),this.pathResolver=n.pathResolver||hr,this.events={success:[],failure:[]},this.ruleResults=[];for(var i in t){var l=void 0;t[i]instanceof Me.default?l=t[i]:l=new Me.default(i,t[i]),this._addConstantFact(l),(0,fe.default)("almanac::constructor initialized runtime fact:"+l.id+" with "+l.value+"<"+tt(l.value)+">")}}return ir(r,[{key:"addEvent",value:function(t,n){if(!n)throw new Error('outcome required: "success" | "failure"]');this.events[n].push(t)}},{key:"getEvents",value:function(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";return t?this.events[t]:this.events.success.concat(this.events.failure)}},{key:"addResult",value:function(t){this.ruleResults.push(t)}},{key:"getResults",value:function(){return this.ruleResults}},{key:"_getFact",value:function(t){return this.factMap.get(t)}},{key:"_addConstantFact",value:function(t){this.factMap.set(t.id,t),this._setFactValue(t,{},t.value)}},{key:"_setFactValue",value:function(t,n,i){var l=t.getCacheKey(n),f=Promise.resolve(i);return l&&this.factResultsCache.set(l,f),f}},{key:"addRuntimeFact",value:function(t,n){(0,fe.default)("almanac::addRuntimeFact id:"+t);var i=new Me.default(t,n);return this._addConstantFact(i)}},{key:"factValue",value:function(t){var n=this,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"",f=void 0,y=this._getFact(t);if(y===void 0)return this.allowUndefinedFacts?Promise.resolve(void 0):Promise.reject(new or.UndefinedFactError("Undefined fact: "+t));if(y.isConstant())f=Promise.resolve(y.calculate(i,this));else{var w=y.getCacheKey(i),R=w&&this.factResultsCache.get(w);R?(f=Promise.resolve(R),(0,fe.default)("almanac::factValue cache hit for fact:"+t)):((0,fe.default)("almanac::factValue cache miss for fact:"+t+"; calculating"),f=this._setFactValue(y,i,y.calculate(i,this)))}return l?((0,fe.default)("condition::evaluate extracting object property "+l),f.then(function(b){if((0,fr.default)(b)){var F=n.pathResolver(b,l);return(0,fe.default)("condition::evaluate extracting object property "+l+", received: "+JSON.stringify(F)),F}else return(0,fe.default)("condition::evaluate could not compute object path("+l+") of non-object: "+b+" <"+(typeof b>"u"?"undefined":tt(b))+">; continuing with "+b),b})):f}}]),r}();Ie.default=dr;var qe={};Object.defineProperty(qe,"__esModule",{value:!0});var vr=me,ae=pr(vr);function pr(r){return r&&r.__esModule?r:{default:r}}var ie=[];ie.push(new ae.default("equal",function(r,e){return r===e})),ie.push(new ae.default("notEqual",function(r,e){return r!==e})),ie.push(new ae.default("in",function(r,e){return e.indexOf(r)>-1})),ie.push(new ae.default("notIn",function(r,e){return e.indexOf(r)===-1})),ie.push(new ae.default("contains",function(r,e){return r.indexOf(e)>-1},Array.isArray)),ie.push(new ae.default("doesNotContain",function(r,e){return r.indexOf(e)===-1},Array.isArray));function Pe(r){return Number.parseFloat(r).toString()!=="NaN"}ie.push(new ae.default("lessThan",function(r,e){return r<e},Pe)),ie.push(new ae.default("lessThanInclusive",function(r,e){return r<=e},Pe)),ie.push(new ae.default("greaterThan",function(r,e){return r>e},Pe)),ie.push(new ae.default("greaterThanInclusive",function(r,e){return r>=e},Pe)),qe.default=ie,Object.defineProperty(se,"__esModule",{value:!0}),se.FINISHED=se.RUNNING=se.READY=void 0;var yr=function(){function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}(),mr=ye,Be=ce(mr),gr=Oe,xe=ce(gr),_r=me,Ue=ce(_r),br=Ie,wr=ce(br),Er=je.exports,Or=ce(Er),Fr=qe,Sr=ce(Fr),Pr=he,ve=ce(Pr);function ce(r){return r&&r.__esModule?r:{default:r}}function Ar(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")}function Rr(r,e){if(!r)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:r}function Tr(r,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);r.prototype=Object.create(e&&e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(r,e):r.__proto__=e)}var kr=se.READY="READY",rt=se.RUNNING="RUNNING",nt=se.FINISHED="FINISHED",jr=function(r){Tr(e,r);function e(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Ar(this,e);var i=Rr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.rules=[],i.allowUndefinedFacts=n.allowUndefinedFacts||!1,i.pathResolver=n.pathResolver,i.operators=new Map,i.facts=new Map,i.status=kr,t.map(function(l){return i.addRule(l)}),Sr.default.map(function(l){return i.addOperator(l)}),i}return yr(e,[{key:"addRule",value:function(n){if(!n)throw new Error("Engine: addRule() requires options");var i=void 0;if(n instanceof xe.default)i=n;else{if(!Object.prototype.hasOwnProperty.call(n,"event"))throw new Error('Engine: addRule() argument requires "event" property');if(!Object.prototype.hasOwnProperty.call(n,"conditions"))throw new Error('Engine: addRule() argument requires "conditions" property');i=new xe.default(n)}return i.setEngine(this),this.rules.push(i),this.prioritizedRules=null,this}},{key:"updateRule",value:function(n){var i=this.rules.findIndex(function(l){return l.name===n.name});if(i>-1)this.rules.splice(i,1),this.addRule(n),this.prioritizedRules=null;else throw new Error("Engine: updateRule() rule not found")}},{key:"removeRule",value:function(n){var i=!1;if(n instanceof xe.default){var f=this.rules.indexOf(n);f>-1&&(i=Boolean(this.rules.splice(f,1).length))}else{var l=this.rules.filter(function(y){return y.name!==n});i=l.length!==this.rules.length,this.rules=l}return i&&(this.prioritizedRules=null),i}},{key:"addOperator",value:function(n,i){var l=void 0;n instanceof Ue.default?l=n:l=new Ue.default(n,i),(0,ve.default)("engine::addOperator name:"+l.name),this.operators.set(l.name,l)}},{key:"removeOperator",value:function(n){var i=void 0;return n instanceof Ue.default?i=n.name:i=n,this.operators.delete(i)}},{key:"addFact",value:function(n,i,l){var f=n,y=void 0;return n instanceof Be.default?(f=n.id,y=n):y=new Be.default(n,i,l),(0,ve.default)("engine::addFact id:"+f),this.facts.set(f,y),this}},{key:"removeFact",value:function(n){var i=void 0;return n instanceof Be.default?i=n.id:i=n,this.facts.delete(i)}},{key:"prioritizeRules",value:function(){if(!this.prioritizedRules){var n=this.rules.reduce(function(i,l){var f=l.priority;return i[f]||(i[f]=[]),i[f].push(l),i},{});this.prioritizedRules=Object.keys(n).sort(function(i,l){return Number(i)>Number(l)?-1:1}).map(function(i){return n[i]})}return this.prioritizedRules}},{key:"stop",value:function(){return this.status=nt,this}},{key:"getFact",value:function(n){return this.facts.get(n)}},{key:"evaluateRules",value:function(n,i){var l=this;return Promise.all(n.map(function(f){return l.status!==rt?((0,ve.default)("engine::run status:"+l.status+"; skipping remaining rules"),Promise.resolve()):f.evaluate(i).then(function(y){return(0,ve.default)("engine::run ruleResult:"+y.result),i.addResult(y),y.result?(i.addEvent(y.event,"success"),l.emitAsync("success",y.event,i,y).then(function(){return l.emitAsync(y.event.type,y.event.params,i,y)})):(i.addEvent(y.event,"failure"),l.emitAsync("failure",y.event,i,y))})}))}},{key:"run",value:function(){var n=this,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};(0,ve.default)("engine::run started"),this.status=rt;var l={allowUndefinedFacts:this.allowUndefinedFacts,pathResolver:this.pathResolver},f=new wr.default(this.facts,i,l),y=this.prioritizeRules(),w=Promise.resolve();return new Promise(function(R,b){y.map(function(F){return w=w.then(function(){return n.evaluateRules(F,f)}).catch(b),w}),w.then(function(){n.status=nt,(0,ve.default)("engine::run completed");var F=f.getResults(),E=F.reduce(function(j,M){var q=M.result?"results":"failureResults";return j[q].push(M),j},{results:[],failureResults:[]}),_=E.results,T=E.failureResults;R({almanac:f,results:_,failureResults:T,events:f.getEvents("success"),failureEvents:f.getEvents("failure")})}).catch(b)})}}]),e}(Or.default);se.default=jr,Object.defineProperty(re,"__esModule",{value:!0}),re.Engine=re.Operator=re.Rule=re.Fact=void 0,re.default=function(r,e){return new it.default(r,e)};var Dr=se,it=Ae(Dr),Ir=ye,Cr=Ae(Ir),Nr=Oe,$r=Ae(Nr),Mr=me,Lr=Ae(Mr);function Ae(r){return r&&r.__esModule?r:{default:r}}re.Fact=Cr.default,re.Rule=$r.default,re.Operator=Lr.default,re.Engine=it.default,function(r){r.exports=re}(Ge);const qr=()=>window.location.pathname;class Br{constructor(e,t){N(this,"data");N(this,"factData");N(this,"store",U.getInstance());N(this,"campId");return this.data=e,this.campId=t,this.prepareFacts()}prepareFacts(){if(this.data.all||this.data.any)return Object.keys(this.data).map(e=>{this.data[e].map(t=>{var n;if(t.fact==="country"&&(this.factData={...this.factData,country:"in"}),t.fact==="spentTimeOnSite"){let i=Number(le(`${this.campId}spentTimeOnSite`));const l=new Date().getTime(),f=Math.trunc((l-this.store.getRecord(`${this.campId}loadTimeSOS`).name)/1e3),y=Math.floor(f/1);i===y&&!this.store.getRecord(`${this.campId}spentTimeOnSite`)&&this.store.addRecord({id:`${this.campId}spentTimeOnSite`,name:!0}),(n=this.store.getRecord(`${this.campId}spentTimeOnSite`))!=null&&n.name?this.factData={...this.factData,spentTimeOnSite:t.value}:this.factData={...this.factData,spentTimeOnSite:0}}if(t.fact==="currentPage"){let i=qr();this.factData={...this.factData,currentPage:i}}if(t.fact==="frequency"){let i=this.checkFrequencyTime(),l=this.checkFrequencyChange();if(i===0&&l===0){this.factData={...this.factData,frequency:"0"};return}l!==0&&i!==0?this.factData={...this.factData,frequency:le(`${this.campId}frequency`)}:this.factData={...this.factData,frequency:"0"}}})}),this.factData}checkFrequencyTime(){let e=le(`${this.campId}frequency`),t,n=e.split(","),i=Number(n[1]),l=n[2],f=0;l==="days"&&(f=86400),l==="hours"&&(f=3600),l==="minutes"&&(f=60),l==="seconds"&&(f=1);const y=new Date().getTime(),w=Math.trunc((y-this.store.getRecord(`${this.campId}loadtime`).name)/1e3);return Math.floor(w/f)!==i&&Math.floor(w/f)<i?t=0:t=e,t}checkFrequencyChange(){var l,f;let e=le(`${this.campId}frequency`),t,n=Number((l=this.store.getRecord(`${this.campId}frequencychange`))==null?void 0:l.name),i=Number((f=this.store.getRecord(`${this.campId}frequency`))==null?void 0:f.name);return n===i||n>i?t=0:t=e,t}}class at{constructor(e,t){N(this,"data");N(this,"factData");this.data=e,this.factData=new Br(e,t)}async checkFacts(){const e=new Ge.exports.Engine;let t=this.data;e.addRule({conditions:t,event:{type:"showPopup",params:{message:"Popup should be shown"}}}),console.log(this.factData);let n=!1;return await e.run(this.factData).then(({events:i})=>{i.map(l=>{l.type==="showPopup"&&(console.log(l.params.message),n=!0)})}),!!n}}class xr{constructor(){N(this,"selectorClicks");N(this,"observe");N(this,"data");N(this,"campId")}initClick(e,t,n,i){this.clickEvent(e),this.selectorClicks={name:"",time:0},this.observe=t,this.observe.subscribe(this),this.data=n,this.campId=i}clickEvent(e){let t={};switch(this.checkSelector(e)){case e.startsWith("."):t.type="Collection",t.nodeElement=document.getElementsByClassName(e.replace(".",""));break;case e.startsWith("#"):t.type="Element",t.nodeElement=document.getElementById(e.replace("#",""));break;default:t.type="Collection",t.nodeElement=document.getElementsByTagName(e);break}this.checkSelector(e)&&(t.type==="Collection"?Array.from(t.nodeElement).map(n=>{this.eventListener(n)}):t.type==="Element"&&this.eventListener(t.nodeElement))}eventListener(e){e.addEventListener("pointerdown",t=>{this.selectorClicks.name=e.nodeName,++this.selectorClicks.time,this.observe.notify("true")})}showModal(e){let t=document.getElementById(`retainful-popup${this.campId}`);try{if(t.style.display==="block")return;t.style.display=e}catch(n){console.log(n)}}checkSelector(e){return document.querySelectorAll(e).length>0}update(){if(Object.keys(this.data).length===0){this.showModal("block");return}const e=new at(this.data,this.campId).checkFacts();console.log("click"),e.then(t=>{t?(this.showModal("block"),this.updateLoadTime()):this.showModal("none")})}updateLoadTime(){var i;const e=U.getInstance(),t=le(`${this.campId}frequency`).split(",")[0];Array.of(Number(t)).fill(0).map((l,f)=>f+1).includes(Number((i=e.getRecord(`${this.campId}frequencychange`))==null?void 0:i.name))||e.updateRecord(`${this.campId}loadtime`,{id:`${this.campId}loadtime`,name:new Date().getTime()})}dummy(){return!0}}class Ur{constructor(){N(this,"observer");N(this,"data");N(this,"campId");N(this,"store")}initMouse(e,t,n){this.watchMouseCursorOut(),this.watchMouseCursorIn(),this.observer=e,this.observer.subscribe(this),this.data=t,this.campId=n,this.store=U.getInstance()}watchMouseCursorOut(){document.addEventListener("mouseout",e=>{(e.clientY<=0||e.clientX<=0||e.clientX>=window.innerWidth||e.clientY>=window.innerHeight)&&(console.log("I'm out"),this.observer.notify("true"))})}watchMouseCursorIn(){document.addEventListener("mousemove",e=>{let t=Number(le(`${this.campId}spentTimeOnSite`));const n=new Date().getTime(),i=Math.trunc((n-this.store.getRecord(`${this.campId}loadTimeSOS`).name)/1e3),l=Math.floor(i/1);t===l&&(this.observer.notify("true"),console.log("pointerin"))})}showModal(e){let t=document.getElementById(`retainful-popup${this.campId}`);try{if(t.style.display==="block")return;t.style.display=e}catch(n){console.log(n)}}update(){if(Object.keys(this.data).length===0){this.showModal("block");return}new at(this.data,this.campId).checkFacts().then(t=>{t?(this.showModal("block"),this.updateLoadTime()):this.showModal("none")})}updateLoadTime(){var i;const e=U.getInstance(),t=le(`${this.campId}frequency`).split(",")[0];Array.of(Number(t)).fill(0).map((l,f)=>f+1).includes(Number((i=e.getRecord(`${this.campId}frequencychange`))==null?void 0:i.name))||e.updateRecord(`${this.campId}loadtime`,{id:`${this.campId}loadtime`,name:new Date().getTime()})}}class Vr{constructor(){N(this,"percentage");N(this,"currentPercentage")}initScrolll(e){this.scroll(),this.percentage=e}percentageStatus(){return Number(this.calPrecentage)===Number(this.percentage)}scroll(){window.addEventListener("scroll",e=>{this.calPrecentage()})}calPrecentage(){this.currentPercentage=Math.floor((this._get_window_Yscroll()+this._get_window_height())/this._get_doc_height()*100)}_get_window_height(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0}_get_window_Yscroll(){return window.pageYOffset||document.body.scrollTop||document.documentElement.scrollTop||0}_get_doc_height(){return Math.max(document.body.scrollHeight||0,document.documentElement.scrollHeight||0,document.body.offsetHeight||0,document.documentElement.offsetHeight||0,document.body.clientHeight||0,document.documentElement.clientHeight||0)}}class Jr{constructor(){N(this,"seconds");N(this,"secondsactive");N(this,"timeid")}initInSeconds(e){this.seconds=e,this.secondsactive=!1,this.calSeconds()}calSeconds(){this.timeid=setTimeout(()=>{this.secondsactive=!0},Number(this.seconds.toString().padEnd(4,"0000")))}closeTimeid(){this.timeid?clearTimeout(this.timeid):console.warn("No Time id")}}function zr(r,e){e.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(n=>{Object.defineProperty(r.prototype,n,Object.getOwnPropertyDescriptor(t.prototype,n)||Object.create(null))})})}class Ve{constructor(e,t){N(this,"enginedata");N(this,"storeInstance");this.storeInstance=t,this.enginedata=e}prepareFactForDb(){var e,t,n;if(this.enginedata.id&&Object.keys(this.enginedata.rules).length>0){const i=(e=this.enginedata.rules.all)==null?void 0:e.filter(y=>y.fact==="spentTimeOnSite"),l=(t=this.enginedata.rules.all)==null?void 0:t.filter(y=>y.fact==="frequency");if((l.length>0||i.length>0)&&(this.storeInstance.addRecord({id:`${this.enginedata.campaign.campaignId}loadtime`,name:new Date().getTime()}),this.storeInstance.addRecord({id:`${this.enginedata.campaign.campaignId}loadTimeSOS`,name:new Date().getTime()})),l.length>0){let y=l[0].value.toString();this.storeInstance.addRecord({id:`${this.enginedata.campaign.campaignId}frequency`,name:y.split(",")[0]}),this.storeInstance.addRecord({id:`${this.enginedata.campaign.campaignId}frequencychange`,name:0}),oe(`${this.enginedata.campaign.campaignId}frequency`,y,1)}i.length>0&&oe(`${this.enginedata.campaign.campaignId}spentTimeOnSite`,i[0].value,1),((n=this.enginedata.rules.all)==null?void 0:n.filter(y=>y.fact==="country")).length>0}}addTriggers(){Object.keys(this.enginedata.actions).map(e=>{if(e==="exit_intent"){const t=new X;Array.isArray(this.enginedata)||this.initMouse(t,this.enginedata.rules,this.enginedata.campaign.campaignId)}if(e==="click"){const t=new X;Array.isArray(this.enginedata)||this.initClick(this.enginedata.actions[e].selector,t,this.enginedata.rules,this.enginedata.campaign.campaignId)}e==="scroll_down"&&this.initScrolll(20),e==="timed"&&this.initInSeconds(2)})}ValidateRulesForEngine(){this.prepareFactForDb(),this.addTriggers()}}zr(Ve,[Vr,Jr,xr,Ur]);class Hr{constructor({data:e,store:t}){N(this,"ruledata");N(this,"store");this.ruledata=e,this.store=t,this.generateRule()}generateRule(){return Array.isArray(this.ruledata)?(this.ruledata.map(e=>{new Ve(e,this.store).ValidateRulesForEngine()}),!0):Array.isArray(this.ruledata)?!1:(new Ve(this.ruledata,this.store).ValidateRulesForEngine(),!0)}show(){console.log("Campaign Show code")}hide(){console.log("Campaign Hide code")}destroy(){console.log("Campaign Destroy code")}}function Gr(r){window.onclick=e=>{var n,i,l;let t;try{if(e.target.parentElement.children.length>2?t=e.target.parentElement.parentElement.id:t=e.target.parentElement.id,t.includes("retainful")){let f=document.getElementById(t);try{if(f.style.display==="block"){f.style.display=r;const y=U.getInstance();Number((n=y.getRecord(`${t[t.length-1]}frequencychange`))==null?void 0:n.name)===0?y.updateRecord(`${t[t.length-1]}frequencychange`,{id:`${t[t.length-1]}frequencychange`,name:1}):Number((i=y.getRecord(`${t[t.length-1]}frequencychange`))==null?void 0:i.name)>0&&y.updateRecord(`${t[t.length-1]}frequencychange`,{id:`${t[t.length-1]}frequencychange`,name:Number((l=y.getRecord(`${t[t.length-1]}frequencychange`))==null?void 0:l.name)+1});let w=le(`${t[t.length-1]}frequency`);oe(`${t[t.length-1]}frequency`,w,1)}}catch(y){console.log(y)}}}catch{return}}}return async function(){let r;function e(){return new Promise(t=>{if(window.RetainfulPopUp!==void 0)return t(r=window.RetainfulPopUp);const n=new MutationObserver(()=>{window.RetainfulPopUp!==void 0&&(t(r=window.RetainfulPopUp),n.disconnect())});n.observe(document.body,{childList:!0})})}await e().then(()=>{if(typeof r=="object"){const t=U.getInstance();r=new Hr({data:r.data,store:t}),window.modal=Gr}else console.warn("Popup not initialized")})}()});
