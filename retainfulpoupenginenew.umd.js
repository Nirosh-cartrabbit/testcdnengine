(function(te,Q){typeof exports=="object"&&typeof module<"u"?module.exports=Q():typeof define=="function"&&define.amd?define(Q):(te=typeof globalThis<"u"?globalThis:te||self,te.retainfulpoupengine=Q())})(this,function(){"use strict";var Qr=Object.defineProperty;var en=(te,Q,oe)=>Q in te?Qr(te,Q,{enumerable:!0,configurable:!0,writable:!0,value:oe}):te[Q]=oe;var M=(te,Q,oe)=>(en(te,typeof Q!="symbol"?Q+"":Q,oe),oe);var te=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Q(t){if(t.__esModule)return t;var e=t.default;if(typeof e=="function"){var r=function n(){if(this instanceof n){var i=[null];i.push.apply(i,arguments);var u=Function.bind.apply(e,i);return new u}return e.apply(this,arguments)};r.prototype=e.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(t).forEach(function(n){var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(r,n,i.get?i:{enumerable:!0,get:function(){return t[n]}})}),r}var oe={},at={get exports(){return oe},set exports(t){oe=t}},re={},se={},ve={},ke={},ot={get exports(){return ke},set exports(t){ke=t}};(function(t,e){(function(r,n){t.exports=n()})(te,function(){function r(s){for(var h=s.length,d=5381,g=52711,A;h--;)A=s.charCodeAt(h),d=d*33^A,g=g*33^A;return(d>>>0)*4096+(g>>>0)}var n=function(h,d){return h.reduce(function(g,A){var E="[object "+A+"]";return d?g[E]=A:g[A]=E,g},{})},i=function(h){return h.reduce(function(d,g){return d[g]=!0,d},{})},u=["Array","Arguments","Object","RegExp","Symbol","Map","Set","Date","Error","Event","Generator","Promise","WeakMap","WeakSet","DocumentFragment","Float32Array","Float64Array","Int8Array","Int16Array","Int32Array","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","ArrayBuffer","DataView","DocumentFragment","Window","String","Number","Boolean","Function","Undefined","GeneratorFunction","BigInt","Null"],c=n(u,!1),m=n(u,!0),_=i([c.Generator,c.Promise,c.WeakMap,c.WeakSet]),T=i([c.Map,c.Set]),b=i([c.Date,c.RegExp]),F=i(["bigint","boolean","function","number","string","undefined"]),O=i([c.Arguments,c.Array]),w=i([c.RegExp,c.Symbol]),k=i([c.Float32Array,c.Float64Array,c.Int8Array,c.Int16Array,c.Int32Array,c.Uint8Array,c.Uint8ClampedArray,c.Uint16Array,c.Uint32Array]),j=typeof Buffer<"u"&&typeof Buffer.from=="function",N=typeof Uint16Array=="function";function x(s){return String.fromCharCode.apply(null,new Uint16Array(s))}function G(s){return Buffer.from(s).toString("utf8")}function ee(s){return""}var U=function(){return j?G:N?x:ee}(),S=/\[object ([HTML|SVG](.*)Element)\]/,q=Object.prototype.toString,R=Object.keys;function Y(s){return{bubbles:s.bubbles,cancelBubble:s.cancelBubble,cancelable:s.cancelable,composed:s.composed,currentTarget:s.currentTarget,defaultPrevented:s.defaultPrevented,eventPhase:s.eventPhase,isTrusted:s.isTrusted,returnValue:s.returnValue,target:s.target,type:s.type}}function C(s,h){return s>h}function I(s,h){return s[0]>h[0]}function V(s,h){for(var d,g,A=0;A<s.length;++A){for(g=s[A],d=A-1;~d&&h(s[d],g);--d)s[d+1]=s[d];s[d+1]=g}return s}function X(s,h,d){var g=[];s.forEach(function(D,$){g.push([o($,h,d),o(D,h,d)])}),V(g,I);for(var A=0,E;A<g.length;++A)E=g[A],g[A]="["+E[0]+","+E[1]+"]";return"Map|["+g.join(",")+"]"}function z(s,h,d){var g=[];return s.forEach(function(A){g.push(o(A,h,d))}),V(g,C),"Set|["+g.join(",")+"]"}function J(s){for(var h=V(R(s),C),d={},g,A=0;A<h.length;++A)g=h[A],d[g]=s[g];return d}function P(s){for(var h=s.children,d=[],g=0;g<h.length;++g)d.push(h[g].outerHTML);return d.join(",")}function H(s,h){for(var d=0;d<s.length;++d)if(s[d]===h)return d+1;return 0}function B(s,h,d,g){if(!g){var A=typeof s;if(F[A])return A+"|"+s;if(s===null)return s+"|"+s}var E=g||q.call(s);return O[E]?s:E===c.Object?J(s):w[E]?m[E]+"|"+s.toString():T[E]?s instanceof Map?X(s,h,d):z(s,h,d):E===c.Date?m[E]+"|"+s.getTime():E===c.Error?m[E]+"|"+s.stack:E===c.Event?Y(s):_[E]?m[E]+"|NOT_ENUMERABLE":S.test(E)?E.slice(8,-1)+"|"+s.outerHTML:E===c.DocumentFragment?m[E]+"|"+P(s):k[E]?m[E]+"|"+s.join(","):E===c.ArrayBuffer?m[E]+"|"+U(s):E===c.DataView?m[E]+"|"+U(s.buffer):s}function a(s,h){return s===void 0&&(s=[]),h===void 0&&(h=[]),function(d,g){if(typeof g=="object")if(s.length){var A=H(s,this);A===0?s.push(this):(s.splice(A),h.splice(A)),h.push(d);var E=H(s,g);if(E!==0)return"[~"+(h.slice(0,E).join(".")||".")+"]";s.push(g)}else s[0]=g,h[0]=d;return d&&this[d]instanceof Date?B(this[d],s,h,c.Date):B(g,s,h)}}function o(s,h,d){if(!s||typeof s!="object")return B(s,h,d);var g=q.call(s);return b[g]?B(s,h,d,g):JSON.stringify(s,a(h,d))}function l(s){return r(o(s))}function f(s,h){return l(s)===l(h)}function p(s){for(var h=0;h<(arguments.length<=1?0:arguments.length-1);++h)if(!f(s,h+1<1||arguments.length<=h+1?void 0:arguments[h+1]))return!1;return!0}function v(s){for(var h=0;h<(arguments.length<=1?0:arguments.length-1);++h)if(f(s,h+1<1||arguments.length<=h+1?void 0:arguments[h+1]))return!0;return!1}function y(s,h){return l(s)!==l(h)}return f.all=p,f.any=v,f.not=y,l.is=f,l})})(ot),Object.defineProperty(ve,"__esModule",{value:!0});var st=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),ut=ke,lt=ct(ut);function ct(t){return t&&t.__esModule?t:{default:t}}function ft(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Re=function(){function t(e,r,n){ft(this,t),this.id=e;var i={cache:!0};if(typeof n>"u"&&(n=i),typeof r!="function"?(this.value=r,this.type=this.constructor.CONSTANT):(this.calculationMethod=r,this.type=this.constructor.DYNAMIC),!this.id)throw new Error("factId required");return this.priority=parseInt(n.priority||1,10),this.options=Object.assign({},i,n),this.cacheKeyMethod=this.defaultCacheKeys,this}return st(t,[{key:"isConstant",value:function(){return this.type===this.constructor.CONSTANT}},{key:"isDynamic",value:function(){return this.type===this.constructor.DYNAMIC}},{key:"calculate",value:function(r,n){return Object.prototype.hasOwnProperty.call(this,"value")?this.value:this.calculationMethod(r,n)}},{key:"defaultCacheKeys",value:function(r,n){return{params:n,id:r}}},{key:"getCacheKey",value:function(r){if(this.options.cache===!0){var n=this.cacheKeyMethod(this.id,r),i=t.hashFromObject(n);return i}}}],[{key:"hashFromObject",value:function(r){return(0,lt.default)(r)}}]),t}();Re.CONSTANT="CONSTANT",Re.DYNAMIC="DYNAMIC",ve.default=Re;var Ee={},je={},fe={};Object.defineProperty(fe,"__esModule",{value:!0}),fe.default=ht;function ht(t){try{(typeof process<"u"&&process.env&&process.env.DEBUG&&process.env.DEBUG.match(/json-rules-engine/)||typeof window<"u"&&window.localStorage&&window.localStorage.debug&&window.localStorage.debug.match(/json-rules-engine/))&&console.log(t)}catch{}}function dt(t){return!!t&&typeof t=="object"}var He=dt;Object.defineProperty(je,"__esModule",{value:!0});var pt=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),vt=fe,mt=We(vt),yt=He,gt=We(yt);function We(t){return t&&t.__esModule?t:{default:t}}function _t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var bt=function(){function t(e){if(_t(this,t),!e)throw new Error("Condition: constructor options required");var r=t.booleanOperator(e);if(Object.assign(this,e),r){var n=e[r];if(!Array.isArray(n))throw new Error('"'+r+'" must be an array');this.operator=r,this.priority=parseInt(e.priority,10)||1,this[r]=n.map(function(i){return new t(i)})}else{if(!Object.prototype.hasOwnProperty.call(e,"fact"))throw new Error('Condition: constructor "fact" property required');if(!Object.prototype.hasOwnProperty.call(e,"operator"))throw new Error('Condition: constructor "operator" property required');if(!Object.prototype.hasOwnProperty.call(e,"value"))throw new Error('Condition: constructor "value" property required');Object.prototype.hasOwnProperty.call(e,"priority")&&(e.priority=parseInt(e.priority,10))}}return pt(t,[{key:"toJSON",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={};this.priority&&(n.priority=this.priority);var i=t.booleanOperator(this);return i?n[i]=this[i].map(function(u){return u.toJSON(r)}):(n.operator=this.operator,n.value=this.value,n.fact=this.fact,this.factResult!==void 0&&(n.factResult=this.factResult),this.result!==void 0&&(n.result=this.result),this.params&&(n.params=this.params),this.path&&(n.path=this.path)),r?JSON.stringify(n):n}},{key:"_getValue",value:function(r){var n=this.value;return(0,gt.default)(n)&&Object.prototype.hasOwnProperty.call(n,"fact")?r.factValue(n.fact,n.params,n.path):Promise.resolve(n)}},{key:"evaluate",value:function(r,n){var i=this;if(!r)return Promise.reject(new Error("almanac required"));if(!n)return Promise.reject(new Error("operatorMap required"));if(this.isBooleanOperator())return Promise.reject(new Error("Cannot evaluate() a boolean condition"));var u=n.get(this.operator);return u?this._getValue(r).then(function(c){return r.factValue(i.fact,i.params,i.path).then(function(m){var _=u.evaluate(m,c);return(0,mt.default)("condition::evaluate <"+JSON.stringify(m)+" "+i.operator+" "+JSON.stringify(c)+"?> ("+_+")"),{result:_,leftHandSideValue:m,rightHandSideValue:c,operator:i.operator}})}):Promise.reject(new Error("Unknown operator: "+this.operator))}},{key:"booleanOperator",value:function(){return t.booleanOperator(this)}},{key:"isBooleanOperator",value:function(){return t.booleanOperator(this)!==void 0}}],[{key:"booleanOperator",value:function(r){if(Object.prototype.hasOwnProperty.call(r,"any"))return"any";if(Object.prototype.hasOwnProperty.call(r,"all"))return"all"}}]),t}();je.default=bt;var Ie={},De={},wt={get exports(){return De},set exports(t){De=t}};(function(t){var e=function(){function r(O,w){return w!=null&&O instanceof w}var n;try{n=Map}catch{n=function(){}}var i;try{i=Set}catch{i=function(){}}var u;try{u=Promise}catch{u=function(){}}function c(O,w,k,j,N){typeof w=="object"&&(k=w.depth,j=w.prototype,N=w.includeNonEnumerable,w=w.circular);var x=[],G=[],ee=typeof Buffer<"u";typeof w>"u"&&(w=!0),typeof k>"u"&&(k=1/0);function U(S,q){if(S===null)return null;if(q===0)return S;var R,Y;if(typeof S!="object")return S;if(r(S,n))R=new n;else if(r(S,i))R=new i;else if(r(S,u))R=new u(function(B,a){S.then(function(o){B(U(o,q-1))},function(o){a(U(o,q-1))})});else if(c.__isArray(S))R=[];else if(c.__isRegExp(S))R=new RegExp(S.source,F(S)),S.lastIndex&&(R.lastIndex=S.lastIndex);else if(c.__isDate(S))R=new Date(S.getTime());else{if(ee&&Buffer.isBuffer(S))return Buffer.allocUnsafe?R=Buffer.allocUnsafe(S.length):R=new Buffer(S.length),S.copy(R),R;r(S,Error)?R=Object.create(S):typeof j>"u"?(Y=Object.getPrototypeOf(S),R=Object.create(Y)):(R=Object.create(j),Y=j)}if(w){var C=x.indexOf(S);if(C!=-1)return G[C];x.push(S),G.push(R)}r(S,n)&&S.forEach(function(B,a){var o=U(a,q-1),l=U(B,q-1);R.set(o,l)}),r(S,i)&&S.forEach(function(B){var a=U(B,q-1);R.add(a)});for(var I in S){var V;Y&&(V=Object.getOwnPropertyDescriptor(Y,I)),!(V&&V.set==null)&&(R[I]=U(S[I],q-1))}if(Object.getOwnPropertySymbols)for(var X=Object.getOwnPropertySymbols(S),I=0;I<X.length;I++){var z=X[I],J=Object.getOwnPropertyDescriptor(S,z);J&&!J.enumerable&&!N||(R[z]=U(S[z],q-1),J.enumerable||Object.defineProperty(R,z,{enumerable:!1}))}if(N)for(var P=Object.getOwnPropertyNames(S),I=0;I<P.length;I++){var H=P[I],J=Object.getOwnPropertyDescriptor(S,H);J&&J.enumerable||(R[H]=U(S[H],q-1),Object.defineProperty(R,H,{enumerable:!1}))}return R}return U(O,k)}c.clonePrototype=function(w){if(w===null)return null;var k=function(){};return k.prototype=w,new k};function m(O){return Object.prototype.toString.call(O)}c.__objToStr=m;function _(O){return typeof O=="object"&&m(O)==="[object Date]"}c.__isDate=_;function T(O){return typeof O=="object"&&m(O)==="[object Array]"}c.__isArray=T;function b(O){return typeof O=="object"&&m(O)==="[object RegExp]"}c.__isRegExp=b;function F(O){var w="";return O.global&&(w+="g"),O.ignoreCase&&(w+="i"),O.multiline&&(w+="m"),w}return c.__getRegExpFlags=F,c}();t.exports&&(t.exports=e)})(wt),Object.defineProperty(Ie,"__esModule",{value:!0});var Ot=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),Et=De,Fe=Ft(Et);function Ft(t){return t&&t.__esModule?t:{default:t}}function St(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Pt=function(){function t(e,r,n,i){St(this,t),this.conditions=(0,Fe.default)(e),this.event=(0,Fe.default)(r),this.priority=(0,Fe.default)(n),this.name=(0,Fe.default)(i),this.result=null}return Ot(t,[{key:"setResult",value:function(r){this.result=r}},{key:"toJSON",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,n={conditions:this.conditions.toJSON(!1),event:this.event,priority:this.priority,name:this.name,result:this.result};return r?JSON.stringify(n):n}}]),t}();Ie.default=Pt;var Se={},At={get exports(){return Se},set exports(t){Se=t}};/*!
 * EventEmitter2
 * https://github.com/hij1nx/EventEmitter2
 *
 * Copyright (c) 2013 hij1nx
 * Licensed under the MIT license.
 */(function(t,e){(function(r){var n=Object.hasOwnProperty,i=Array.isArray?Array.isArray:function(o){return Object.prototype.toString.call(o)==="[object Array]"},u=10,c=typeof process=="object"&&typeof process.nextTick=="function",m=typeof Symbol=="function",_=typeof Reflect=="object",T=typeof setImmediate=="function",b=T?setImmediate:setTimeout,F=m?_&&typeof Reflect.ownKeys=="function"?Reflect.ownKeys:function(a){var o=Object.getOwnPropertyNames(a);return o.push.apply(o,Object.getOwnPropertySymbols(a)),o}:Object.keys;function O(){this._events={},this._conf&&w.call(this,this._conf)}function w(a){a&&(this._conf=a,a.delimiter&&(this.delimiter=a.delimiter),a.maxListeners!==r&&(this._maxListeners=a.maxListeners),a.wildcard&&(this.wildcard=a.wildcard),a.newListener&&(this._newListener=a.newListener),a.removeListener&&(this._removeListener=a.removeListener),a.verboseMemoryLeak&&(this.verboseMemoryLeak=a.verboseMemoryLeak),a.ignoreErrors&&(this.ignoreErrors=a.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function k(a,o){var l="(node) warning: possible EventEmitter memory leak detected. "+a+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(l+=" Event name: "+o+"."),typeof process<"u"&&process.emitWarning){var f=new Error(l);f.name="MaxListenersExceededWarning",f.emitter=this,f.count=a,process.emitWarning(f)}else console.error(l),console.trace&&console.trace()}var j=function(a,o,l){var f=arguments.length;switch(f){case 0:return[];case 1:return[a];case 2:return[a,o];case 3:return[a,o,l];default:for(var p=new Array(f);f--;)p[f]=arguments[f];return p}};function N(a,o){for(var l={},f,p=a.length,v=o?o.length:0,y=0;y<p;y++)f=a[y],l[f]=y<v?o[y]:r;return l}function x(a,o,l){this._emitter=a,this._target=o,this._listeners={},this._listenersCount=0;var f,p;if((l.on||l.off)&&(f=l.on,p=l.off),o.addEventListener?(f=o.addEventListener,p=o.removeEventListener):o.addListener?(f=o.addListener,p=o.removeListener):o.on&&(f=o.on,p=o.off),!f&&!p)throw Error("target does not implement any known event API");if(typeof f!="function")throw TypeError("on method must be a function");if(typeof p!="function")throw TypeError("off method must be a function");this._on=f,this._off=p;var v=a._observers;v?v.push(this):a._observers=[this]}Object.assign(x.prototype,{subscribe:function(a,o,l){var f=this,p=this._target,v=this._emitter,y=this._listeners,s=function(){var h=j.apply(null,arguments),d={data:h,name:o,original:a};if(l){var g=l.call(p,d);g!==!1&&v.emit.apply(v,[d.name].concat(h));return}v.emit.apply(v,[o].concat(h))};if(y[a])throw Error("Event '"+a+"' is already listening");this._listenersCount++,v._newListener&&v._removeListener&&!f._onNewListener?(this._onNewListener=function(h){h===o&&y[a]===null&&(y[a]=s,f._on.call(p,a,s))},v.on("newListener",this._onNewListener),this._onRemoveListener=function(h){h===o&&!v.hasListeners(h)&&y[a]&&(y[a]=null,f._off.call(p,a,s))},y[a]=null,v.on("removeListener",this._onRemoveListener)):(y[a]=s,f._on.call(p,a,s))},unsubscribe:function(a){var o=this,l=this._listeners,f=this._emitter,p,v,y=this._off,s=this._target,h;if(a&&typeof a!="string")throw TypeError("event must be a string");function d(){o._onNewListener&&(f.off("newListener",o._onNewListener),f.off("removeListener",o._onRemoveListener),o._onNewListener=null,o._onRemoveListener=null);var g=Y.call(f,o);f._observers.splice(g,1)}if(a){if(p=l[a],!p)return;y.call(s,a,p),delete l[a],--this._listenersCount||d()}else{for(v=F(l),h=v.length;h-- >0;)a=v[h],y.call(s,a,l[a]);this._listeners={},this._listenersCount=0,d()}}});function G(a,o,l,f){var p=Object.assign({},o);if(!a)return p;if(typeof a!="object")throw TypeError("options must be an object");var v=Object.keys(a),y=v.length,s,h,d;function g(E){throw Error('Invalid "'+s+'" option value'+(E?". Reason: "+E:""))}for(var A=0;A<y;A++){if(s=v[A],!f&&!n.call(o,s))throw Error('Unknown "'+s+'" option');h=a[s],h!==r&&(d=l[s],p[s]=d?d(h,g):h)}return p}function ee(a,o){return(typeof a!="function"||!a.hasOwnProperty("prototype"))&&o("value must be a constructor"),a}function U(a){var o="value must be type of "+a.join("|"),l=a.length,f=a[0],p=a[1];return l===1?function(v,y){if(typeof v===f)return v;y(o)}:l===2?function(v,y){var s=typeof v;if(s===f||s===p)return v;y(o)}:function(v,y){for(var s=typeof v,h=l;h-- >0;)if(s===a[h])return v;y(o)}}var S=U(["function"]),q=U(["object","function"]);function R(a,o,l){var f,p,v=0,y,s=new a(function(h,d,g){l=G(l,{timeout:0,overload:!1},{timeout:function($,W){return $*=1,(typeof $!="number"||$<0||!Number.isFinite($))&&W("timeout must be a positive number"),$}}),f=!l.overload&&typeof a.prototype.cancel=="function"&&typeof g=="function";function A(){p&&(p=null),v&&(clearTimeout(v),v=0)}var E=function($){A(),h($)},D=function($){A(),d($)};f?o(E,D,g):(p=[function($){D($||Error("canceled"))}],o(E,D,function($){if(y)throw Error("Unable to subscribe on cancel event asynchronously");if(typeof $!="function")throw TypeError("onCancel callback must be a function");p.push($)}),y=!0),l.timeout>0&&(v=setTimeout(function(){var $=Error("timeout");$.code="ETIMEDOUT",v=0,s.cancel($),d($)},l.timeout))});return f||(s.cancel=function(h){if(p){for(var d=p.length,g=1;g<d;g++)p[g](h);p[0](h),p=null}}),s}function Y(a){var o=this._observers;if(!o)return-1;for(var l=o.length,f=0;f<l;f++)if(o[f]._target===a)return f;return-1}function C(a,o,l,f,p){if(!l)return null;if(f===0){var v=typeof o;if(v==="string"){var y,s,h=0,d=0,g=this.delimiter,A=g.length;if((s=o.indexOf(g))!==-1){y=new Array(5);do y[h++]=o.slice(d,s),d=s+A;while((s=o.indexOf(g,d))!==-1);y[h++]=o.slice(d),o=y,p=h}else o=[o],p=1}else v==="object"?p=o.length:(o=[o],p=1)}var E=null,D,$,W,Je,Ge,Oe=o[f],Ye=o[f+1],ue,Z;if(f===p)l._listeners&&(typeof l._listeners=="function"?(a&&a.push(l._listeners),E=[l]):(a&&a.push.apply(a,l._listeners),E=[l]));else if(Oe==="*"){for(ue=F(l),s=ue.length;s-- >0;)D=ue[s],D!=="_listeners"&&(Z=C(a,o,l[D],f+1,p),Z&&(E?E.push.apply(E,Z):E=Z));return E}else if(Oe==="**"){for(Ge=f+1===p||f+2===p&&Ye==="*",Ge&&l._listeners&&(E=C(a,o,l,p,p)),ue=F(l),s=ue.length;s-- >0;)D=ue[s],D!=="_listeners"&&(D==="*"||D==="**"?(l[D]._listeners&&!Ge&&(Z=C(a,o,l[D],p,p),Z&&(E?E.push.apply(E,Z):E=Z)),Z=C(a,o,l[D],f,p)):D===Ye?Z=C(a,o,l[D],f+2,p):Z=C(a,o,l[D],f,p),Z&&(E?E.push.apply(E,Z):E=Z));return E}else l[Oe]&&(E=C(a,o,l[Oe],f+1,p));if($=l["*"],$&&C(a,o,$,f+1,p),W=l["**"],W)if(f<p)for(W._listeners&&C(a,o,W,p,p),ue=F(W),s=ue.length;s-- >0;)D=ue[s],D!=="_listeners"&&(D===Ye?C(a,o,W[D],f+2,p):D===Oe?C(a,o,W[D],f+1,p):(Je={},Je[D]=W[D],C(a,o,{"**":Je},f+1,p)));else W._listeners?C(a,o,W,p,p):W["*"]&&W["*"]._listeners&&C(a,o,W["*"],p,p);return E}function I(a,o,l){var f=0,p=0,v,y=this.delimiter,s=y.length,h;if(typeof a=="string")if((v=a.indexOf(y))!==-1){h=new Array(5);do h[f++]=a.slice(p,v),p=v+s;while((v=a.indexOf(y,p))!==-1);h[f++]=a.slice(p)}else h=[a],f=1;else h=a,f=a.length;if(f>1){for(v=0;v+1<f;v++)if(h[v]==="**"&&h[v+1]==="**")return}var d=this.listenerTree,g;for(v=0;v<f;v++)if(g=h[v],d=d[g]||(d[g]={}),v===f-1)return d._listeners?(typeof d._listeners=="function"&&(d._listeners=[d._listeners]),l?d._listeners.unshift(o):d._listeners.push(o),!d._listeners.warned&&this._maxListeners>0&&d._listeners.length>this._maxListeners&&(d._listeners.warned=!0,k.call(this,d._listeners.length,g))):d._listeners=o,!0;return!0}function V(a,o,l,f){for(var p=F(a),v=p.length,y,s,h,d=a._listeners,g;v-- >0;)s=p[v],y=a[s],s==="_listeners"?h=l:h=l?l.concat(s):[s],g=f||typeof s=="symbol",d&&o.push(g?h:h.join(this.delimiter)),typeof y=="object"&&V.call(this,y,o,h,g);return o}function X(a){for(var o=F(a),l=o.length,f,p,v;l-- >0;)p=o[l],f=a[p],f&&(v=!0,p!=="_listeners"&&!X(f)&&delete a[p]);return v}function z(a,o,l){this.emitter=a,this.event=o,this.listener=l}z.prototype.off=function(){return this.emitter.off(this.event,this.listener),this};function J(a,o,l){if(l===!0)p=!0;else if(l===!1)f=!0;else{if(!l||typeof l!="object")throw TypeError("options should be an object or true");var f=l.async,p=l.promisify,v=l.nextTick,y=l.objectify}if(f||v||p){var s=o,h=o._origin||o;if(v&&!c)throw Error("process.nextTick is not supported");p===r&&(p=o.constructor.name==="AsyncFunction"),o=function(){var d=arguments,g=this,A=this.event;return p?v?Promise.resolve():new Promise(function(E){b(E)}).then(function(){return g.event=A,s.apply(g,d)}):(v?process.nextTick:b)(function(){g.event=A,s.apply(g,d)})},o._async=!0,o._origin=h}return[o,y?new z(this,a,o):this]}function P(a){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,w.call(this,a)}P.EventEmitter2=P,P.prototype.listenTo=function(a,o,l){if(typeof a!="object")throw TypeError("target musts be an object");var f=this;l=G(l,{on:r,off:r,reducers:r},{on:S,off:S,reducers:q});function p(v){if(typeof v!="object")throw TypeError("events must be an object");var y=l.reducers,s=Y.call(f,a),h;s===-1?h=new x(f,a,l):h=f._observers[s];for(var d=F(v),g=d.length,A,E=typeof y=="function",D=0;D<g;D++)A=d[D],h.subscribe(A,v[A]||A,E?y:y&&y[A])}return i(o)?p(N(o)):p(typeof o=="string"?N(o.split(/\s+/)):o),this},P.prototype.stopListeningTo=function(a,o){var l=this._observers;if(!l)return!1;var f=l.length,p,v=!1;if(a&&typeof a!="object")throw TypeError("target should be an object");for(;f-- >0;)p=l[f],(!a||p._target===a)&&(p.unsubscribe(o),v=!0);return v},P.prototype.delimiter=".",P.prototype.setMaxListeners=function(a){a!==r&&(this._maxListeners=a,this._conf||(this._conf={}),this._conf.maxListeners=a)},P.prototype.getMaxListeners=function(){return this._maxListeners},P.prototype.event="",P.prototype.once=function(a,o,l){return this._once(a,o,!1,l)},P.prototype.prependOnceListener=function(a,o,l){return this._once(a,o,!0,l)},P.prototype._once=function(a,o,l,f){return this._many(a,1,o,l,f)},P.prototype.many=function(a,o,l,f){return this._many(a,o,l,!1,f)},P.prototype.prependMany=function(a,o,l,f){return this._many(a,o,l,!0,f)},P.prototype._many=function(a,o,l,f,p){var v=this;if(typeof l!="function")throw new Error("many only accepts instances of Function");function y(){return--o===0&&v.off(a,y),l.apply(this,arguments)}return y._origin=l,this._on(a,y,f,p)},P.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||O.call(this);var a=arguments[0],o,l=this.wildcard,f,p,v,y,s;if(a==="newListener"&&!this._newListener&&!this._events.newListener)return!1;if(l&&(o=a,a!=="newListener"&&a!=="removeListener"&&typeof a=="object")){if(p=a.length,m){for(v=0;v<p;v++)if(typeof a[v]=="symbol"){s=!0;break}}s||(a=a.join(this.delimiter))}var h=arguments.length,d;if(this._all&&this._all.length)for(d=this._all.slice(),v=0,p=d.length;v<p;v++)switch(this.event=a,h){case 1:d[v].call(this,a);break;case 2:d[v].call(this,a,arguments[1]);break;case 3:d[v].call(this,a,arguments[1],arguments[2]);break;default:d[v].apply(this,arguments)}if(l)d=[],C.call(this,d,o,this.listenerTree,0,p);else if(d=this._events[a],typeof d=="function"){switch(this.event=a,h){case 1:d.call(this);break;case 2:d.call(this,arguments[1]);break;case 3:d.call(this,arguments[1],arguments[2]);break;default:for(f=new Array(h-1),y=1;y<h;y++)f[y-1]=arguments[y];d.apply(this,f)}return!0}else d&&(d=d.slice());if(d&&d.length){if(h>3)for(f=new Array(h-1),y=1;y<h;y++)f[y-1]=arguments[y];for(v=0,p=d.length;v<p;v++)switch(this.event=a,h){case 1:d[v].call(this);break;case 2:d[v].call(this,arguments[1]);break;case 3:d[v].call(this,arguments[1],arguments[2]);break;default:d[v].apply(this,f)}return!0}else if(!this.ignoreErrors&&!this._all&&a==="error")throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},P.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||O.call(this);var a=arguments[0],o=this.wildcard,l,f,p,v,y,s;if(a==="newListener"&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(l=a,a!=="newListener"&&a!=="removeListener"&&typeof a=="object")){if(v=a.length,m){for(y=0;y<v;y++)if(typeof a[y]=="symbol"){f=!0;break}}f||(a=a.join(this.delimiter))}var h=[],d=arguments.length,g;if(this._all)for(y=0,v=this._all.length;y<v;y++)switch(this.event=a,d){case 1:h.push(this._all[y].call(this,a));break;case 2:h.push(this._all[y].call(this,a,arguments[1]));break;case 3:h.push(this._all[y].call(this,a,arguments[1],arguments[2]));break;default:h.push(this._all[y].apply(this,arguments))}if(o?(g=[],C.call(this,g,l,this.listenerTree,0)):g=this._events[a],typeof g=="function")switch(this.event=a,d){case 1:h.push(g.call(this));break;case 2:h.push(g.call(this,arguments[1]));break;case 3:h.push(g.call(this,arguments[1],arguments[2]));break;default:for(p=new Array(d-1),s=1;s<d;s++)p[s-1]=arguments[s];h.push(g.apply(this,p))}else if(g&&g.length){if(g=g.slice(),d>3)for(p=new Array(d-1),s=1;s<d;s++)p[s-1]=arguments[s];for(y=0,v=g.length;y<v;y++)switch(this.event=a,d){case 1:h.push(g[y].call(this));break;case 2:h.push(g[y].call(this,arguments[1]));break;case 3:h.push(g[y].call(this,arguments[1],arguments[2]));break;default:h.push(g[y].apply(this,p))}}else if(!this.ignoreErrors&&!this._all&&a==="error")return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(h)},P.prototype.on=function(a,o,l){return this._on(a,o,!1,l)},P.prototype.prependListener=function(a,o,l){return this._on(a,o,!0,l)},P.prototype.onAny=function(a){return this._onAny(a,!1)},P.prototype.prependAny=function(a){return this._onAny(a,!0)},P.prototype.addListener=P.prototype.on,P.prototype._onAny=function(a,o){if(typeof a!="function")throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),o?this._all.unshift(a):this._all.push(a),this},P.prototype._on=function(a,o,l,f){if(typeof a=="function")return this._onAny(a,o),this;if(typeof o!="function")throw new Error("on only accepts instances of Function");this._events||O.call(this);var p=this,v;return f!==r&&(v=J.call(this,a,o,f),o=v[0],p=v[1]),this._newListener&&this.emit("newListener",a,o),this.wildcard?(I.call(this,a,o,l),p):(this._events[a]?(typeof this._events[a]=="function"&&(this._events[a]=[this._events[a]]),l?this._events[a].unshift(o):this._events[a].push(o),!this._events[a].warned&&this._maxListeners>0&&this._events[a].length>this._maxListeners&&(this._events[a].warned=!0,k.call(this,this._events[a].length,a))):this._events[a]=o,p)},P.prototype.off=function(a,o){if(typeof o!="function")throw new Error("removeListener only takes instances of Function");var l,f=[];if(this.wildcard){var p=typeof a=="string"?a.split(this.delimiter):a.slice();if(f=C.call(this,null,p,this.listenerTree,0),!f)return this}else{if(!this._events[a])return this;l=this._events[a],f.push({_listeners:l})}for(var v=0;v<f.length;v++){var y=f[v];if(l=y._listeners,i(l)){for(var s=-1,h=0,d=l.length;h<d;h++)if(l[h]===o||l[h].listener&&l[h].listener===o||l[h]._origin&&l[h]._origin===o){s=h;break}if(s<0)continue;return this.wildcard?y._listeners.splice(s,1):this._events[a].splice(s,1),l.length===0&&(this.wildcard?delete y._listeners:delete this._events[a]),this._removeListener&&this.emit("removeListener",a,o),this}else(l===o||l.listener&&l.listener===o||l._origin&&l._origin===o)&&(this.wildcard?delete y._listeners:delete this._events[a],this._removeListener&&this.emit("removeListener",a,o))}return this.listenerTree&&X(this.listenerTree),this},P.prototype.offAny=function(a){var o=0,l=0,f;if(a&&this._all&&this._all.length>0){for(f=this._all,o=0,l=f.length;o<l;o++)if(a===f[o])return f.splice(o,1),this._removeListener&&this.emit("removeListenerAny",a),this}else{if(f=this._all,this._removeListener)for(o=0,l=f.length;o<l;o++)this.emit("removeListenerAny",f[o]);this._all=[]}return this},P.prototype.removeListener=P.prototype.off,P.prototype.removeAllListeners=function(a){if(a===r)return!this._events||O.call(this),this;if(this.wildcard){var o=C.call(this,null,a,this.listenerTree,0),l,f;if(!o)return this;for(f=0;f<o.length;f++)l=o[f],l._listeners=null;this.listenerTree&&X(this.listenerTree)}else this._events&&(this._events[a]=null);return this},P.prototype.listeners=function(a){var o=this._events,l,f,p,v,y;if(a===r){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(l=F(o),v=l.length,p=[];v-- >0;)f=o[l[v]],typeof f=="function"?p.push(f):p.push.apply(p,f);return p}else{if(this.wildcard){if(y=this.listenerTree,!y)return[];var s=[],h=typeof a=="string"?a.split(this.delimiter):a.slice();return C.call(this,s,h,y,0),s}return o?(f=o[a],f?typeof f=="function"?[f]:f:[]):[]}},P.prototype.eventNames=function(a){var o=this._events;return this.wildcard?V.call(this,this.listenerTree,[],null,a):o?F(o):[]},P.prototype.listenerCount=function(a){return this.listeners(a).length},P.prototype.hasListeners=function(a){if(this.wildcard){var o=[],l=typeof a=="string"?a.split(this.delimiter):a.slice();return C.call(this,o,l,this.listenerTree,0),o.length>0}var f=this._events,p=this._all;return!!(p&&p.length||f&&(a===r?F(f).length:f[a]))},P.prototype.listenersAny=function(){return this._all?this._all:[]},P.prototype.waitFor=function(a,o){var l=this,f=typeof o;return f==="number"?o={timeout:o}:f==="function"&&(o={filter:o}),o=G(o,{timeout:0,filter:r,handleError:!1,Promise,overload:!1},{filter:S,Promise:ee}),R(o.Promise,function(p,v,y){function s(){var h=o.filter;if(!(h&&!h.apply(l,arguments)))if(l.off(a,s),o.handleError){var d=arguments[0];d?v(d):p(j.apply(null,arguments).slice(1))}else p(j.apply(null,arguments))}y(function(){l.off(a,s)}),l._on(a,s,!1)},{timeout:o.timeout,overload:o.overload})};function H(a,o,l){l=G(l,{Promise,timeout:0,overload:!1},{Promise:ee});var f=l.Promise;return R(f,function(p,v,y){var s;if(typeof a.addEventListener=="function"){s=function(){p(j.apply(null,arguments))},y(function(){a.removeEventListener(o,s)}),a.addEventListener(o,s,{once:!0});return}var h=function(){d&&a.removeListener("error",d),p(j.apply(null,arguments))},d;o!=="error"&&(d=function(g){a.removeListener(o,h),v(g)},a.once("error",d)),y(function(){d&&a.removeListener("error",d),a.removeListener(o,h)}),a.once(o,h)},{timeout:l.timeout,overload:l.overload})}var B=P.prototype;Object.defineProperties(P,{defaultMaxListeners:{get:function(){return B._maxListeners},set:function(a){if(typeof a!="number"||a<0||Number.isNaN(a))throw TypeError("n must be a non-negative number");B._maxListeners=a},enumerable:!0},once:{value:H,writable:!0,configurable:!0}}),Object.defineProperties(B,{_maxListeners:{value:u,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),typeof r=="function"&&r.amd?r(function(){return P}):t.exports=P})()})(At),Object.defineProperty(Ee,"__esModule",{value:!0});var Tt=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),kt=je,Rt=Pe(kt),jt=Ie,It=Pe(jt),Dt=fe,Ce=Pe(Dt),Ct=Se,Lt=Pe(Ct);function Pe(t){return t&&t.__esModule?t:{default:t}}function Nt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function $t(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t}function Mt(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var xt=function(t){Mt(e,t);function e(r){Nt(this,e);var n=$t(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));typeof r=="string"&&(r=JSON.parse(r)),r&&r.conditions&&n.setConditions(r.conditions),r&&r.onSuccess&&n.on("success",r.onSuccess),r&&r.onFailure&&n.on("failure",r.onFailure),r&&(r.name||r.name===0)&&n.setName(r.name);var i=r&&r.priority||1;n.setPriority(i);var u=r&&r.event||{type:"unknown"};return n.setEvent(u),n}return Tt(e,[{key:"setPriority",value:function(n){if(n=parseInt(n,10),n<=0)throw new Error("Priority must be greater than zero");return this.priority=n,this}},{key:"setName",value:function(n){if(!n&&n!==0)throw new Error('Rule "name" must be defined');return this.name=n,this}},{key:"setConditions",value:function(n){if(!Object.prototype.hasOwnProperty.call(n,"all")&&!Object.prototype.hasOwnProperty.call(n,"any"))throw new Error('"conditions" root must contain a single instance of "all" or "any"');return this.conditions=new Rt.default(n),this}},{key:"setEvent",value:function(n){if(!n)throw new Error("Rule: setEvent() requires event object");if(!Object.prototype.hasOwnProperty.call(n,"type"))throw new Error('Rule: setEvent() requires event object with "type" property');return this.ruleEvent={type:n.type},n.params&&(this.ruleEvent.params=n.params),this}},{key:"getEvent",value:function(){return this.ruleEvent}},{key:"getPriority",value:function(){return this.priority}},{key:"getConditions",value:function(){return this.conditions}},{key:"getEngine",value:function(){return this.engine}},{key:"setEngine",value:function(n){return this.engine=n,this}},{key:"toJSON",value:function(){var n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i={conditions:this.conditions.toJSON(!1),priority:this.priority,event:this.ruleEvent,name:this.name};return n?JSON.stringify(i):i}},{key:"prioritizeConditions",value:function(n){var i=this,u=n.reduce(function(c,m){var _=m.priority;if(!_){var T=i.engine.getFact(m.fact);_=T&&T.priority||1}return c[_]||(c[_]=[]),c[_].push(m),c},{});return Object.keys(u).sort(function(c,m){return Number(c)>Number(m)?-1:1}).map(function(c){return u[c]})}},{key:"evaluate",value:function(n){var i=this,u=new It.default(this.conditions,this.ruleEvent,this.priority,this.name),c=function(w){if(w.isBooleanOperator()){var k=w[w.operator],j=void 0;return w.operator==="all"?j=b(k):j=T(k),j.then(function(N){var x=N===!0;return w.result=x,x})}else return w.evaluate(n,i.engine.operators).then(function(N){var x=N.result;return w.factResult=N.leftHandSideValue,w.result=x,x})},m=function(w,k){return Array.isArray(w)||(w=[w]),Promise.all(w.map(function(j){return c(j)})).then(function(j){return(0,Ce.default)("rule::evaluateConditions results",j),k.call(j,function(N){return N===!0})})},_=function(w,k){if(w.length===0)return Promise.resolve(!0);var j=Array.prototype.some;k==="all"&&(j=Array.prototype.every);for(var N=i.prioritizeConditions(w),x=Promise.resolve(),G=function(S){var q=N[S],R=!1;x=x.then(function(Y){return k==="any"&&Y===!0||R?((0,Ce.default)("prioritizeAndRun::detected truthy result; skipping remaining conditions"),R=!0,!0):k==="all"&&Y===!1||R?((0,Ce.default)("prioritizeAndRun::detected falsey result; skipping remaining conditions"),R=!0,!1):m(q,j)})},ee=0;ee<N.length;ee++)G(ee);return x},T=function(w){return _(w,"any")},b=function(w){return _(w,"all")},F=function(w){u.setResult(w);var k=w?"success":"failure";return i.emitAsync(k,u.event,n,u).then(function(){return u})};return u.conditions.any?T(u.conditions.any).then(function(O){return F(O)}):b(u.conditions.all).then(function(O){return F(O)})}}]),e}(Lt.default);Ee.default=xt;var me={};Object.defineProperty(me,"__esModule",{value:!0});var qt=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function Bt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var Ut=function(){function t(e,r,n){if(Bt(this,t),this.name=String(e),!e)throw new Error("Missing operator name");if(typeof r!="function")throw new Error("Missing operator callback");this.cb=r,this.factValueValidator=n,this.factValueValidator||(this.factValueValidator=function(){return!0})}return qt(t,[{key:"evaluate",value:function(r,n){return this.factValueValidator(r)&&this.cb(r,n)}}]),t}();me.default=Ut;var Le={},Ne={};Object.defineProperty(Ne,"__esModule",{value:!0});function zt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Vt(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t}function Jt(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}Ne.UndefinedFactError=function(t){Jt(e,t);function e(){var r;zt(this,e);for(var n=arguments.length,i=Array(n),u=0;u<n;u++)i[u]=arguments[u];var c=Vt(this,(r=e.__proto__||Object.getPrototypeOf(e)).call.apply(r,[this].concat(i)));return c.code="UNDEFINED_FACT",c}return e}(Error);function ne(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?ne=function(e){return typeof e}:ne=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ne(t)}function Gt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Yt(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&ge(t,e)}function ye(t){return ye=Object.setPrototypeOf?Object.getPrototypeOf:function(r){return r.__proto__||Object.getPrototypeOf(r)},ye(t)}function ge(t,e){return ge=Object.setPrototypeOf||function(n,i){return n.__proto__=i,n},ge(t,e)}function Ke(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function _e(t,e,r){return Ke()?_e=Reflect.construct:_e=function(i,u,c){var m=[null];m.push.apply(m,u);var _=Function.bind.apply(i,m),T=new _;return c&&ge(T,c.prototype),T},_e.apply(null,arguments)}function Ht(t){return Function.toString.call(t).indexOf("[native code]")!==-1}function $e(t){var e=typeof Map=="function"?new Map:void 0;return $e=function(n){if(n===null||!Ht(n))return n;if(typeof n!="function")throw new TypeError("Super expression must either be null or a function");if(typeof e<"u"){if(e.has(n))return e.get(n);e.set(n,i)}function i(){return _e(n,arguments,ye(this).constructor)}return i.prototype=Object.create(n.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),ge(i,n)},$e(t)}function Wt(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function Kt(t,e){return e&&(typeof e=="object"||typeof e=="function")?e:Wt(t)}function Xt(t){var e=Ke();return function(){var n=ye(t),i;if(e){var u=ye(this).constructor;i=Reflect.construct(n,arguments,u)}else i=n.apply(this,arguments);return Kt(this,i)}}function Xe(t){return Zt(t)||Qt(t)||Ze(t)||er()}function Zt(t){if(Array.isArray(t))return Me(t)}function Qt(t){if(typeof Symbol<"u"&&t[Symbol.iterator]!=null||t["@@iterator"]!=null)return Array.from(t)}function Ze(t,e){if(t){if(typeof t=="string")return Me(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);if(r==="Object"&&t.constructor&&(r=t.constructor.name),r==="Map"||r==="Set")return Array.from(t);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return Me(t,e)}}function Me(t,e){(e==null||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function er(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function tr(t,e){var r=typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=Ze(t))||e&&t&&typeof t.length=="number"){r&&(t=r);var n=0,i=function(){};return{s:i,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(_){throw _},f:i}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var u=!0,c=!1,m;return{s:function(){r=r.call(t)},n:function(){var _=r.next();return u=_.done,_},e:function(_){c=!0,m=_},f:function(){try{!u&&r.return!=null&&r.return()}finally{if(c)throw m}}}}var K=Object.prototype.hasOwnProperty;function be(t,e){return t=t.slice(),t.push(e),t}function he(t,e){return e=e.slice(),e.unshift(t),e}var rr=function(t){Yt(r,t);var e=Xt(r);function r(n){var i;return Gt(this,r),i=e.call(this,'JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),i.avoidNew=!0,i.value=n,i.name="NewError",i}return r}($e(Error));function L(t,e,r,n,i){if(!(this instanceof L))try{return new L(t,e,r,n,i)}catch(_){if(!_.avoidNew)throw _;return _.value}typeof t=="string"&&(i=n,n=r,r=e,e=t,t=null);var u=t&&ne(t)==="object";if(t=t||{},this.json=t.json||r,this.path=t.path||e,this.resultType=t.resultType||"value",this.flatten=t.flatten||!1,this.wrap=K.call(t,"wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},this.preventEval=t.preventEval||!1,this.parent=t.parent||null,this.parentProperty=t.parentProperty||null,this.callback=t.callback||n||null,this.otherTypeCallback=t.otherTypeCallback||i||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},t.autostart!==!1){var c={path:u?t.path:e};u?"json"in t&&(c.json=t.json):c.json=r;var m=this.evaluate(c);if(!m||ne(m)!=="object")throw new rr(m);return m}}L.prototype.evaluate=function(t,e,r,n){var i=this,u=this.parent,c=this.parentProperty,m=this.flatten,_=this.wrap;if(this.currResultType=this.resultType,this.currPreventEval=this.preventEval,this.currSandbox=this.sandbox,r=r||this.callback,this.currOtherTypeCallback=n||this.otherTypeCallback,e=e||this.json,t=t||this.path,t&&ne(t)==="object"&&!Array.isArray(t)){if(!t.path&&t.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!K.call(t,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');var T=t;e=T.json,m=K.call(t,"flatten")?t.flatten:m,this.currResultType=K.call(t,"resultType")?t.resultType:this.currResultType,this.currSandbox=K.call(t,"sandbox")?t.sandbox:this.currSandbox,_=K.call(t,"wrap")?t.wrap:_,this.currPreventEval=K.call(t,"preventEval")?t.preventEval:this.currPreventEval,r=K.call(t,"callback")?t.callback:r,this.currOtherTypeCallback=K.call(t,"otherTypeCallback")?t.otherTypeCallback:this.currOtherTypeCallback,u=K.call(t,"parent")?t.parent:u,c=K.call(t,"parentProperty")?t.parentProperty:c,t=t.path}if(u=u||null,c=c||null,Array.isArray(t)&&(t=L.toPathString(t)),!(!t&&t!==""||!e)){var b=L.toPathArray(t);b[0]==="$"&&b.length>1&&b.shift(),this._hasParentSelector=null;var F=this._trace(b,e,["$"],u,c,r).filter(function(O){return O&&!O.isParentSelector});return F.length?!_&&F.length===1&&!F[0].hasArrExpr?this._getPreferredOutput(F[0]):F.reduce(function(O,w){var k=i._getPreferredOutput(w);return m&&Array.isArray(k)?O=O.concat(k):O.push(k),O},[]):_?[]:void 0}},L.prototype._getPreferredOutput=function(t){var e=this.currResultType;switch(e){case"all":{var r=Array.isArray(t.path)?t.path:L.toPathArray(t.path);return t.pointer=L.toPointer(r),t.path=typeof t.path=="string"?t.path:L.toPathString(t.path),t}case"value":case"parent":case"parentProperty":return t[e];case"path":return L.toPathString(t[e]);case"pointer":return L.toPointer(t.path);default:throw new TypeError("Unknown result type")}},L.prototype._handleCallback=function(t,e,r){if(e){var n=this._getPreferredOutput(t);t.path=typeof t.path=="string"?t.path:L.toPathString(t.path),e(n,r,t)}},L.prototype._trace=function(t,e,r,n,i,u,c,m){var _=this,T;if(!t.length)return T={path:r,value:e,parent:n,parentProperty:i,hasArrExpr:c},this._handleCallback(T,u,"value"),T;var b=t[0],F=t.slice(1),O=[];function w(I){Array.isArray(I)?I.forEach(function(V){O.push(V)}):O.push(I)}if((typeof b!="string"||m)&&e&&K.call(e,b))w(this._trace(F,e[b],be(r,b),e,b,u,c));else if(b==="*")this._walk(b,F,e,r,n,i,u,function(I,V,X,z,J,P,H,B){w(_._trace(he(I,X),z,J,P,H,B,!0,!0))});else if(b==="..")w(this._trace(F,e,r,n,i,u,c)),this._walk(b,F,e,r,n,i,u,function(I,V,X,z,J,P,H,B){ne(z[I])==="object"&&w(_._trace(he(V,X),z[I],be(J,I),z,I,B,!0))});else{if(b==="^")return this._hasParentSelector=!0,{path:r.slice(0,-1),expr:F,isParentSelector:!0};if(b==="~")return T={path:be(r,b),value:i,parent:n,parentProperty:null},this._handleCallback(T,u,"property"),T;if(b==="$")w(this._trace(F,e,r,null,null,u,c));else if(/^(\x2D?[0-9]*):(\x2D?[0-9]*):?([0-9]*)$/.test(b))w(this._slice(b,F,e,r,n,i,u));else if(b.indexOf("?(")===0){if(this.currPreventEval)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");this._walk(b,F,e,r,n,i,u,function(I,V,X,z,J,P,H,B){_._eval(V.replace(/^\?\(((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?)\)$/,"$1"),z[I],I,J,P,H)&&w(_._trace(he(I,X),z,J,P,H,B,!0))})}else if(b[0]==="("){if(this.currPreventEval)throw new Error("Eval [(expr)] prevented in JSONPath expression.");w(this._trace(he(this._eval(b,e,r[r.length-1],r.slice(0,-1),n,i),F),e,r,n,i,u,c))}else if(b[0]==="@"){var k=!1,j=b.slice(1,-2);switch(j){case"scalar":(!e||!["object","function"].includes(ne(e)))&&(k=!0);break;case"boolean":case"string":case"undefined":case"function":ne(e)===j&&(k=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(k=!0);break;case"number":Number.isFinite(e)&&(k=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(k=!0);break;case"object":e&&ne(e)===j&&(k=!0);break;case"array":Array.isArray(e)&&(k=!0);break;case"other":k=this.currOtherTypeCallback(e,r,n,i);break;case"null":e===null&&(k=!0);break;default:throw new TypeError("Unknown value type "+j)}if(k)return T={path:r,value:e,parent:n,parentProperty:i},this._handleCallback(T,u,"value"),T}else if(b[0]==="`"&&e&&K.call(e,b.slice(1))){var N=b.slice(1);w(this._trace(F,e[N],be(r,N),e,N,u,c,!0))}else if(b.includes(",")){var x=b.split(","),G=tr(x),ee;try{for(G.s();!(ee=G.n()).done;){var U=ee.value;w(this._trace(he(U,F),e,r,n,i,u,!0))}}catch(I){G.e(I)}finally{G.f()}}else!m&&e&&K.call(e,b)&&w(this._trace(F,e[b],be(r,b),e,b,u,c,!0))}if(this._hasParentSelector)for(var S=0;S<O.length;S++){var q=O[S];if(q&&q.isParentSelector){var R=this._trace(q.expr,e,q.path,n,i,u,c);if(Array.isArray(R)){O[S]=R[0];for(var Y=R.length,C=1;C<Y;C++)S++,O.splice(S,0,R[C])}else O[S]=R}}return O},L.prototype._walk=function(t,e,r,n,i,u,c,m){if(Array.isArray(r))for(var _=r.length,T=0;T<_;T++)m(T,t,e,r,n,i,u,c);else r&&ne(r)==="object"&&Object.keys(r).forEach(function(b){m(b,t,e,r,n,i,u,c)})},L.prototype._slice=function(t,e,r,n,i,u,c){if(Array.isArray(r)){var m=r.length,_=t.split(":"),T=_[2]&&Number.parseInt(_[2])||1,b=_[0]&&Number.parseInt(_[0])||0,F=_[1]&&Number.parseInt(_[1])||m;b=b<0?Math.max(0,b+m):Math.min(m,b),F=F<0?Math.max(0,F+m):Math.min(m,F);for(var O=[],w=b;w<F;w+=T){var k=this._trace(he(w,e),r,n,i,u,c,!0);k.forEach(function(j){O.push(j)})}return O}},L.prototype._eval=function(t,e,r,n,i,u){t.includes("@parentProperty")&&(this.currSandbox._$_parentProperty=u,t=t.replace(/@parentProperty/g,"_$_parentProperty")),t.includes("@parent")&&(this.currSandbox._$_parent=i,t=t.replace(/@parent/g,"_$_parent")),t.includes("@property")&&(this.currSandbox._$_property=r,t=t.replace(/@property/g,"_$_property")),t.includes("@path")&&(this.currSandbox._$_path=L.toPathString(n.concat([r])),t=t.replace(/@path/g,"_$_path")),t.includes("@root")&&(this.currSandbox._$_root=this.json,t=t.replace(/@root/g,"_$_root")),/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/.test(t)&&(this.currSandbox._$_v=e,t=t.replace(/@([\t-\r \)\.\[\xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF])/g,"_$_v$1"));try{return this.vm.runInNewContext(t,this.currSandbox)}catch(c){throw console.log(c),new Error("jsonPath: "+c.message+": "+t)}},L.cache={},L.toPathString=function(t){for(var e=t,r=e.length,n="$",i=1;i<r;i++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[i])||(n+=/^[\*0-9]+$/.test(e[i])?"["+e[i]+"]":"['"+e[i]+"']");return n},L.toPointer=function(t){for(var e=t,r=e.length,n="",i=1;i<r;i++)/^(~|\^|@(?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\(\))$/.test(e[i])||(n+="/"+e[i].toString().replace(/~/g,"~0").replace(/\//g,"~1"));return n},L.toPathArray=function(t){var e=L.cache;if(e[t])return e[t].concat();var r=[],n=t.replace(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/g,";$&;").replace(/['\[](\??\((?:[\0-\t\x0B\f\x0E-\u2027\u202A-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF])*?\))['\]]/g,function(u,c){return"[#"+(r.push(c)-1)+"]"}).replace(/\[["']((?:(?!['\]])[\s\S])*)["']\]/g,function(u,c){return"['"+c.replace(/\./g,"%@%").replace(/~/g,"%%@@%%")+"']"}).replace(/~/g,";~;").replace(/["']?\.["']?(?!(?:(?!\[)[\s\S])*\])|\[["']?/g,";").replace(/%@%/g,".").replace(/%%@@%%/g,"~").replace(/(?:;)?(\^+)(?:;)?/g,function(u,c){return";"+c.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),i=n.split(";").map(function(u){var c=u.match(/#([0-9]+)/);return!c||!c[1]?u:r[c[1]]});return e[t]=i,e[t].concat()};var nr=function(e,r,n){for(var i=e.length,u=0;u<i;u++){var c=e[u];n(c)&&r.push(e.splice(u--,1)[0])}};L.prototype.vm={runInNewContext:function(e,r){var n=Object.keys(r),i=[];nr(n,i,function(T){return typeof r[T]=="function"});var u=n.map(function(T,b){return r[T]}),c=i.reduce(function(T,b){var F=r[b].toString();return/function/.test(F)||(F="function "+F),"var "+b+"="+F+";"+T},"");e=c+e,!/(["'])use strict\1/.test(e)&&!n.includes("arguments")&&(e="var arguments = undefined;"+e),e=e.replace(/;[\t-\r \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000\uFEFF]*$/,"");var m=e.lastIndexOf(";"),_=m>-1?e.slice(0,m+1)+" return "+e.slice(m+1):" return "+e;return _e(Function,Xe(n).concat([_])).apply(void 0,Xe(u))}};const ir=Q(Object.freeze(Object.defineProperty({__proto__:null,JSONPath:L},Symbol.toStringTag,{value:"Module"})));Object.defineProperty(Le,"__esModule",{value:!0});var Qe=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ar=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),or=ve,xe=qe(or),sr=Ne,ur=fe,le=qe(ur),lr=ir,cr=He,fr=qe(cr);function qe(t){return t&&t.__esModule?t:{default:t}}function hr(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function dr(t,e){return(0,lr.JSONPath)({path:e,json:t,wrap:!1})}var pr=function(){function t(e){var r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};hr(this,t),this.factMap=new Map(e),this.factResultsCache=new Map,this.allowUndefinedFacts=Boolean(n.allowUndefinedFacts),this.pathResolver=n.pathResolver||dr,this.events={success:[],failure:[]},this.ruleResults=[];for(var i in r){var u=void 0;r[i]instanceof xe.default?u=r[i]:u=new xe.default(i,r[i]),this._addConstantFact(u),(0,le.default)("almanac::constructor initialized runtime fact:"+u.id+" with "+u.value+"<"+Qe(u.value)+">")}}return ar(t,[{key:"addEvent",value:function(r,n){if(!n)throw new Error('outcome required: "success" | "failure"]');this.events[n].push(r)}},{key:"getEvents",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"";return r?this.events[r]:this.events.success.concat(this.events.failure)}},{key:"addResult",value:function(r){this.ruleResults.push(r)}},{key:"getResults",value:function(){return this.ruleResults}},{key:"_getFact",value:function(r){return this.factMap.get(r)}},{key:"_addConstantFact",value:function(r){this.factMap.set(r.id,r),this._setFactValue(r,{},r.value)}},{key:"_setFactValue",value:function(r,n,i){var u=r.getCacheKey(n),c=Promise.resolve(i);return u&&this.factResultsCache.set(u,c),c}},{key:"addRuntimeFact",value:function(r,n){(0,le.default)("almanac::addRuntimeFact id:"+r);var i=new xe.default(r,n);return this._addConstantFact(i)}},{key:"factValue",value:function(r){var n=this,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"",c=void 0,m=this._getFact(r);if(m===void 0)return this.allowUndefinedFacts?Promise.resolve(void 0):Promise.reject(new sr.UndefinedFactError("Undefined fact: "+r));if(m.isConstant())c=Promise.resolve(m.calculate(i,this));else{var _=m.getCacheKey(i),T=_&&this.factResultsCache.get(_);T?(c=Promise.resolve(T),(0,le.default)("almanac::factValue cache hit for fact:"+r)):((0,le.default)("almanac::factValue cache miss for fact:"+r+"; calculating"),c=this._setFactValue(m,i,m.calculate(i,this)))}return u?((0,le.default)("condition::evaluate extracting object property "+u),c.then(function(b){if((0,fr.default)(b)){var F=n.pathResolver(b,u);return(0,le.default)("condition::evaluate extracting object property "+u+", received: "+JSON.stringify(F)),F}else return(0,le.default)("condition::evaluate could not compute object path("+u+") of non-object: "+b+" <"+(typeof b>"u"?"undefined":Qe(b))+">; continuing with "+b),b})):c}}]),t}();Le.default=pr;var Be={};Object.defineProperty(Be,"__esModule",{value:!0});var vr=me,ae=mr(vr);function mr(t){return t&&t.__esModule?t:{default:t}}var ie=[];ie.push(new ae.default("equal",function(t,e){return t===e})),ie.push(new ae.default("notEqual",function(t,e){return t!==e})),ie.push(new ae.default("in",function(t,e){return e.indexOf(t)>-1})),ie.push(new ae.default("notIn",function(t,e){return e.indexOf(t)===-1})),ie.push(new ae.default("contains",function(t,e){return t.indexOf(e)>-1},Array.isArray)),ie.push(new ae.default("doesNotContain",function(t,e){return t.indexOf(e)===-1},Array.isArray));function Ae(t){return Number.parseFloat(t).toString()!=="NaN"}ie.push(new ae.default("lessThan",function(t,e){return t<e},Ae)),ie.push(new ae.default("lessThanInclusive",function(t,e){return t<=e},Ae)),ie.push(new ae.default("greaterThan",function(t,e){return t>e},Ae)),ie.push(new ae.default("greaterThanInclusive",function(t,e){return t>=e},Ae)),Be.default=ie,Object.defineProperty(se,"__esModule",{value:!0}),se.FINISHED=se.RUNNING=se.READY=void 0;var yr=function(){function t(e,r){for(var n=0;n<r.length;n++){var i=r[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),gr=ve,Ue=ce(gr),_r=Ee,ze=ce(_r),br=me,Ve=ce(br),wr=Le,Or=ce(wr),Er=Se,Fr=ce(Er),Sr=Be,Pr=ce(Sr),Ar=fe,de=ce(Ar);function ce(t){return t&&t.__esModule?t:{default:t}}function Tr(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function kr(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t}function Rr(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var jr=se.READY="READY",et=se.RUNNING="RUNNING",tt=se.FINISHED="FINISHED",Ir=function(t){Rr(e,t);function e(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};Tr(this,e);var i=kr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.rules=[],i.allowUndefinedFacts=n.allowUndefinedFacts||!1,i.pathResolver=n.pathResolver,i.operators=new Map,i.facts=new Map,i.status=jr,r.map(function(u){return i.addRule(u)}),Pr.default.map(function(u){return i.addOperator(u)}),i}return yr(e,[{key:"addRule",value:function(n){if(!n)throw new Error("Engine: addRule() requires options");var i=void 0;if(n instanceof ze.default)i=n;else{if(!Object.prototype.hasOwnProperty.call(n,"event"))throw new Error('Engine: addRule() argument requires "event" property');if(!Object.prototype.hasOwnProperty.call(n,"conditions"))throw new Error('Engine: addRule() argument requires "conditions" property');i=new ze.default(n)}return i.setEngine(this),this.rules.push(i),this.prioritizedRules=null,this}},{key:"updateRule",value:function(n){var i=this.rules.findIndex(function(u){return u.name===n.name});if(i>-1)this.rules.splice(i,1),this.addRule(n),this.prioritizedRules=null;else throw new Error("Engine: updateRule() rule not found")}},{key:"removeRule",value:function(n){var i=!1;if(n instanceof ze.default){var c=this.rules.indexOf(n);c>-1&&(i=Boolean(this.rules.splice(c,1).length))}else{var u=this.rules.filter(function(m){return m.name!==n});i=u.length!==this.rules.length,this.rules=u}return i&&(this.prioritizedRules=null),i}},{key:"addOperator",value:function(n,i){var u=void 0;n instanceof Ve.default?u=n:u=new Ve.default(n,i),(0,de.default)("engine::addOperator name:"+u.name),this.operators.set(u.name,u)}},{key:"removeOperator",value:function(n){var i=void 0;return n instanceof Ve.default?i=n.name:i=n,this.operators.delete(i)}},{key:"addFact",value:function(n,i,u){var c=n,m=void 0;return n instanceof Ue.default?(c=n.id,m=n):m=new Ue.default(n,i,u),(0,de.default)("engine::addFact id:"+c),this.facts.set(c,m),this}},{key:"removeFact",value:function(n){var i=void 0;return n instanceof Ue.default?i=n.id:i=n,this.facts.delete(i)}},{key:"prioritizeRules",value:function(){if(!this.prioritizedRules){var n=this.rules.reduce(function(i,u){var c=u.priority;return i[c]||(i[c]=[]),i[c].push(u),i},{});this.prioritizedRules=Object.keys(n).sort(function(i,u){return Number(i)>Number(u)?-1:1}).map(function(i){return n[i]})}return this.prioritizedRules}},{key:"stop",value:function(){return this.status=tt,this}},{key:"getFact",value:function(n){return this.facts.get(n)}},{key:"evaluateRules",value:function(n,i){var u=this;return Promise.all(n.map(function(c){return u.status!==et?((0,de.default)("engine::run status:"+u.status+"; skipping remaining rules"),Promise.resolve()):c.evaluate(i).then(function(m){return(0,de.default)("engine::run ruleResult:"+m.result),i.addResult(m),m.result?(i.addEvent(m.event,"success"),u.emitAsync("success",m.event,i,m).then(function(){return u.emitAsync(m.event.type,m.event.params,i,m)})):(i.addEvent(m.event,"failure"),u.emitAsync("failure",m.event,i,m))})}))}},{key:"run",value:function(){var n=this,i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};(0,de.default)("engine::run started"),this.status=et;var u={allowUndefinedFacts:this.allowUndefinedFacts,pathResolver:this.pathResolver},c=new Or.default(this.facts,i,u),m=this.prioritizeRules(),_=Promise.resolve();return new Promise(function(T,b){m.map(function(F){return _=_.then(function(){return n.evaluateRules(F,c)}).catch(b),_}),_.then(function(){n.status=tt,(0,de.default)("engine::run completed");var F=c.getResults(),O=F.reduce(function(j,N){var x=N.result?"results":"failureResults";return j[x].push(N),j},{results:[],failureResults:[]}),w=O.results,k=O.failureResults;T({almanac:c,results:w,failureResults:k,events:c.getEvents("success"),failureEvents:c.getEvents("failure")})}).catch(b)})}}]),e}(Fr.default);se.default=Ir,Object.defineProperty(re,"__esModule",{value:!0}),re.Engine=re.Operator=re.Rule=re.Fact=void 0,re.default=function(t,e){return new rt.default(t,e)};var Dr=se,rt=Te(Dr),Cr=ve,Lr=Te(Cr),Nr=Ee,$r=Te(Nr),Mr=me,xr=Te(Mr);function Te(t){return t&&t.__esModule?t:{default:t}}re.Fact=Lr.default,re.Rule=$r.default,re.Operator=xr.default,re.Engine=rt.default,function(t){t.exports=re}(at);class qr{constructor(){M(this,"records",[])}getRecords(){return this.records}addRecord(e){this.records.push(e)}getRecord(e){return this.records.find(r=>r.id===e)}deleteRecord(e){this.records=this.records.filter(r=>r.id!==e)}updateRecord(e,r){this.records=this.records.map(n=>n.id===e?r:n)}checkRecord(e){return!!this.records.find(n=>n.id===e)}}class Br{createFact(e,r){return r.addRecord({id:"country",name:"in"}),this}getFact(e,r){var u;return{country:(u=r.getRecord("country"))==null?void 0:u.name}}}class Ur{createFact(e,r){return r.addRecord({id:"currentPage",name:"/"}),this}getFact(e,r){var u;return{currentPage:(u=r.getRecord("currentPage"))==null?void 0:u.name}}}function nt(t,e,r){const n=new Date;n.setTime(n.getTime()+r*24*60*60*1e3);const i="expires="+n.toUTCString();document.cookie=t+"="+e+";"+i+";path=/"}function pe(t){var n;const r=("; "+document.cookie).split("; "+t+"=");return r.length==2?(n=r.pop())==null?void 0:n.split(";").shift():""}class zr{createFact(e,r){var u;const n=(u=e.rules.all)==null?void 0:u.filter(c=>c.fact==="frequency");r.addRecord({id:`${e.campaign.campaignId}loadtime`,name:new Date().getTime()});let i=n[0].value.toString();return r.addRecord({id:`${e.campaign.campaignId}frequency`,name:i.split(",")[0]}),r.addRecord({id:`${e.campaign.campaignId}frequencychange`,name:0}),nt(`${e.campaign.campaignId}frequency`,i,1),this}getFact(e,r){let n=this.checkFrequencyTime(e.campaign.campaignId,r),i=this.checkFrequencyChange(e.campaign.campaignId,r);return n===0&&i===0?{frequency:"0"}:i!==0&&n!==0?{frequency:pe(`${e.campaign.campaignId}frequency`)}:{frequency:"0"}}checkFrequencyTime(e,r){let n=pe(`${e}frequency`),i,u=n.split(","),c=Number(u[1]),m=u[2],_=0;m==="days"&&(_=86400),m==="hours"&&(_=3600),m==="minutes"&&(_=60),m==="seconds"&&(_=1);const T=new Date().getTime(),b=Math.trunc((T-r.getRecord(`${e}loadtime`).name)/1e3);return Math.floor(b/_)!==c&&Math.floor(b/_)<c?i=0:i=n,i}checkFrequencyChange(e,r){var m,_;let n=pe(`${e}frequency`),i,u=Number((m=r.getRecord(`${e}frequencychange`))==null?void 0:m.name),c=Number((_=r.getRecord(`${e}frequency`))==null?void 0:_.name);return u===c||u>c?i=0:i=n,i}}class Vr{createFact(e,r){var i;const n=(i=e.rules.all)==null?void 0:i.filter(u=>u.fact==="spentTimeOnSite");return r.addRecord({id:`${e.campaign.campaignId}loadTimeSOS`,name:new Date().getTime()}),nt(`${e.campaign.campaignId}spentTimeOnSite`,n[0].value,1),this}getFact(e,r){var m;let n=Number(pe(`${e.campaign.campaignId}spentTimeOnSite`));const i=new Date().getTime(),u=Math.trunc((i-r.getRecord(`${e.campaign.campaignId}loadTimeSOS`).name)/1e3),c=Math.floor(u/1);return n===c&&!r.getRecord(`${e.campaign.campaignId}spentTimeOnSite`)&&r.addRecord({id:`${e.campaign.campaignId}spentTimeOnSite`,name:!0}),(m=r.getRecord(`${e.campaign.campaignId}spentTimeOnSite`))!=null&&m.name?{spentTimeOnSite:n}:{spentTimeOnSite:0}}}class Jr{createFact(e){return this.createFactObject(e)}createFactObject(e){switch(e){case"spentTimeOnSite":return new Vr;case"frequency":return new zr;case"country":return new Br;case"currentPage":return new Ur;default:throw new Error(`Invalid fact type: ${e}`)}}getFact(e){return this.createFactObject(e)}}class Gr{constructor(e){M(this,"factFactoryinstance",[]);M(this,"store",new qr);M(this,"factData",{});this.data=e}createFact(){"rules"in this.data?this.data.rules.all.map(e=>{let r=new Jr().createFact(e.fact);this.factFactoryinstance.push(r.createFact(this.data,this.store))}):this.factFactoryinstance=[]}generateFact(){return this.factFactoryinstance.map(e=>{this.factData={...this.factData,...e.getFact(this.data,this.store)}}),!!this.factData}async validateFact(e,r){const n=new oe.Engine;n.addRule({conditions:e,event:{type:"showPopup",params:{message:"Popup should be shown"}}});let i=!1;return await n.run(r).then(({events:u})=>{u.map(c=>{c.type==="showPopup"&&(console.log(c.params.message),i=!0)})}),!!i}getFact(e){return this.store.getRecord(e)}checkRecord(e){return this.store.checkRecord(e)}}class Yr{constructor(e,r){M(this,"domPopupid");this.componentData=e,this.id=r}launch(){switch(!0){case!Array.isArray(this.componentData):if(this.componentData.actions){let r,n=document.createElement("div");n.innerHTML=this.componentData.template.html,n.id=this.id+this.componentData.campaign.campaignId,document.body.appendChild(n),r=this.id+this.componentData.campaign.campaignId,this.domPopupid=r;break}else break;case Array.isArray(this.componentData):let e;this.componentData.forEach(r=>{let n=document.createElement("div");n.innerHTML=r.template.html,n.id=this.id+r.campaign.campaignId,e={...e,id:this.id+r.campaign.campaignId},document.body.appendChild(n)}),this.domPopupid=e;break;default:console.log("UI not Initialised");break}return{open:this.open,close:this.close,destroy:this.destroy,uIid:this.domPopupid}}open(e){let r=document.getElementById(this.domPopupid);try{r.style.display="block",e&&e()}catch(n){console.log(n)}}close(e){let r=document.getElementById(this.domPopupid);try{r.style.display="none",e&&e()}catch(n){console.log(n)}}destroy(){try{document.getElementById(this.domPopupid).remove()}catch(e){console.warn(e)}}}class Hr{constructor(){M(this,"observers");this.observers=[]}subscribe(e){this.observers.push(e)}unsubscribe(e){this.observers=this.observers.filter(r=>r!==e)}notifyObservers(e){this.observers.forEach(r=>{r.update(e)})}notifyObserver(e){e.update()}}class Wr{constructor(e,r,n,i,u){M(this,"observer");M(this,"data");M(this,"campId");M(this,"store");M(this,"factInstance");M(this,"launcher");this.observer=e,this.observer.subscribe(this),this.data=r,this.campId=r.campaign.campaignId,this.store=i,this.factInstance=u,this.launcher=n,this.createTrigger()}createTrigger(){this.watchMouseCursorOut()}getTrigger(){return this}watchMouseCursorOut(){document.addEventListener("mouseout",e=>{(e.clientY<=0||e.clientX<=0||e.clientX>=window.innerWidth||e.clientY>=window.innerHeight)&&(console.log("I'm out"),this.observer.notifyObserver(this))})}watchMouseCursorIn(){document.addEventListener("mousemove",e=>{this.factInstance.checkRecord(`${this.campId}spentTimeOnSite`)||(this.observer.notifyObserver(this),console.log("pointerin"))})}showModal(e){let r=document.getElementById(`retainful-popup${this.campId}`);try{if(r.style.display==="block")return;r.style.display=e}catch(n){console.log(n)}}modalStatus(){return document.getElementById(`retainful-popup${this.campId}`).style.display!=="block"}update(){let e=this.factInstance;if(e.store.records.length!==0){if(this.modalStatus()&&e.generateFact()){const n=e.factData;console.log("Exit intent trigger fact: ",n),e.validateFact(this.data.rules,n).then(u=>{u?(this.launcher.open(),this.updateLoadTime()):this.launcher.close()})}}else this.modalStatus()&&this.launcher.open()}updateLoadTime(){var n;const e=pe(`${this.campId}frequency`).split(",")[0];Array.of(Number(e)).fill(0).map((i,u)=>u+1).includes(Number((n=this.store.getRecord(`${this.campId}frequencychange`))==null?void 0:n.name))||this.store.updateRecord(`${this.campId}loadtime`,{id:`${this.campId}loadtime`,name:new Date().getTime()})}}class Kr{constructor(e,r,n,i,u){M(this,"selectorClicks");M(this,"observe");M(this,"data");M(this,"campId");M(this,"fact");M(this,"launcher");M(this,"store");M(this,"factInstance");this.clickEvent(r.actions.click.selector),this.selectorClicks={name:"",time:0},this.observe=e,this.observe.subscribe(this),this.data=r,this.campId=r.campaign.campaignId,this.store=i,this.launcher=n,this.factInstance=u}getTrigger(){return this}clickEvent(e){let r={};switch(this.checkSelector(e)){case e.startsWith("."):r.type="Collection",r.nodeElement=document.getElementsByClassName(e.replace(".",""));break;case e.startsWith("#"):r.type="Element",r.nodeElement=document.getElementById(e.replace("#",""));break;default:r.type="Collection",r.nodeElement=document.getElementsByTagName(e);break}this.checkSelector(e)&&(r.type==="Collection"?Array.from(r.nodeElement).map(n=>{this.eventListener(n)}):r.type==="Element"&&this.eventListener(r.nodeElement))}eventListener(e){e.addEventListener("pointerdown",r=>{this.selectorClicks.name=e.nodeName,++this.selectorClicks.time,this.observe.notifyObserver(this)})}showModal(e){let r=document.getElementById(`retainful-popup${this.campId}`);try{if(r.style.display==="block")return;r.style.display=e}catch(n){console.log(n)}}modalStatus(){return document.getElementById(`retainful-popup${this.campId}`).style.display!=="block"}checkSelector(e){if(document.querySelectorAll(e).length>0)return document.querySelectorAll(e).length>0;console.warn("Popup not initialized")}update(){let e=this.factInstance;if(e.store.records.length!==0){if(this.modalStatus()&&e.generateFact()){const n=e.factData;console.log("Click Trigger Fact: ",n),e.validateFact(this.data.rules,n).then(u=>{u?(this.launcher.open(),this.updateLoadTime()):this.launcher.close()})}}else this.modalStatus()&&this.launcher.open()}updateLoadTime(){var n;const e=pe(`${this.campId}frequency`).split(",")[0];Array.of(Number(e)).fill(0).map((i,u)=>u+1).includes(Number((n=this.store.getRecord(`${this.campId}frequencychange`))==null?void 0:n.name))||this.store.updateRecord(`${this.campId}loadtime`,{id:`${this.campId}loadtime`,name:new Date().getTime()})}}class Xr{createTrigger(e,r,n,i,u,c){return this.createTriggerObject(e,r,n,i,u,c)}createTriggerObject(e,r,n,i,u,c){switch(e){case"exit_intent":return new Wr(r,n,c,i,u);case"click":return new Kr(r,n,c,i,u);default:throw new Error(`Invalid trigger type: ${e}`)}}}class Zr{constructor(e,r){M(this,"TriggerInstance",[]);M(this,"Observer",new Hr);this.FactInstance=e,this.LauncherInstance=r}createTrigger(e){Object.keys(e.actions).map(r=>{this.TriggerInstance.push(new Xr().createTrigger(r,this.Observer,e,this.FactInstance.store,this.FactInstance,this.LauncherInstance))})}}class it{create(e){const r=new Yr(e,"retainful-popup");r.launch();const n=new Gr(e);return n.createFact(),new Zr(n,r).createTrigger(e),r}}let we=[{id:"636209a003eaff00257e810c",campaign:{campaignName:"Campaign #1",campaignPriority:"NORMAL",campaignId:1},actions:{click:{selector:"#hhh"},exit_intent:{device:"desktop_and_mobile"}},rules:{all:[{fact:"currentPage",operator:"equal",value:"/"},{fact:"country",operator:"equal",value:"in"},{fact:"frequency",operator:"equal",value:"2,11,seconds"}]},template:{positions:[],animation:"zoomIn",type:"Bristol",displayGroup:{type:"responsive",position:"top"},html:`<div class="modal" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: auto; display: inline-flex; flex-direction: column; align-items: center; padding: 1.6rem 3rem; border: 3px solid black; border-radius: 5px; background: white; box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.2);">
        <p class="message" style="font-size: 1.1rem; margin-bottom: 1.6rem; margin-top: 0;">Look at this fancy pop-up</p>
        <div class="options" style="display: flex; flex-direction: row; justify-content: space-between;">
          <button class="btn" style="color: inherit; font-family: inherit; font-size: inherit; background: white; padding: 0.3rem 3.4rem; border: 3px solid black; margin-right: 2.6rem; box-shadow: 0 0 0 black; transition: all 0.2s;">Yes</button>
          <button class="btn" style="color: inherit; font-family: inherit; font-size: inherit; background: white; padding: 0.3rem 3.4rem; border: 3px solid black; margin-right: 2.6rem; box-shadow: 0 0 0 black; transition: all 0.2s; margin: 0;">No</button>
        </div>
      </div>`},settings:{closeGestures:{onEsc:!0,onOverlayClick:!1,onOverlayClickDevice:"mobile"}}},{id:"636209a003eaff00257e810cdasdasd",campaign:{campaignName:"Campaign #2",campaignPriority:"NORMAL",campaignId:2},actions:{click:{selector:"#camp2"}},rules:{all:[{fact:"currentPage",operator:"equal",value:"/"}]},template:{positions:[],animation:"zoomIn",type:"Bristol",displayGroup:{type:"responsive",position:"top"},html:`<div        style="padding:20px;background:#ADD8E6;width:15%;color:blue;text-align:center;border-radius:10px;position:absolute;bottom:20px">
      Teaser</div>
      <button class="btn" style="
                        color: inherit;
                        font-family: inherit;
                        font-size: inherit;
                        background: white;
                        border: 3px solid black;
                        border-radius: 5px;
                        margin-right: 2.6rem;
                        box-shadow: 0 0 0 black;
                        transition: all 0.2s;
                        position: absolute;
                        bottom: 70px;
                        left: 220px;
                      " onclick="window.modal('none')">
        X
      </button>`},settings:{closeGestures:{onEsc:!0,onOverlayClick:!1,onOverlayClickDevice:"mobile"}}}];return window.RetainfulPopUp=we,async function(){let t;function e(){return new Promise(r=>{if(window.RetainfulPopUp!==void 0)return r(t=window.RetainfulPopUp);const n=new MutationObserver(()=>{window.RetainfulPopUp!==void 0&&(r(t=window.RetainfulPopUp),n.disconnect())});n.observe(document.body,{childList:!0})})}await e().then(()=>{if(typeof t=="object")if(Array.isArray(we)){let r;we.forEach((n,i)=>r={...r,[`Campaign${i+1}`]:new it().create(n)}),window.camp=r}else Array.isArray(we)||(window.camp=new it().create(we));else console.warn("Popup not initialized")})}()});
